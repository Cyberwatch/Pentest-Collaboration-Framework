<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
<style>
    #canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        width: 25em !important;
        height: 25em !important;
        margin: auto;
    }
    
    #chartjs-tooltip {
        opacity: 1;
        position: absolute;
        background: rgba(0, 0, 0, .7);
        color: white;
        border-radius: 3px;
        -webkit-transition: all .1s ease;
        transition: all .1s ease;
        pointer-events: none;
        -webkit-transform: translate(-50%, 0);
        transform: translate(-50%, 0);
    }

    .chartjs-tooltip-key {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 10px;
    }
</style>
<script src=https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js></script>
<script>
    var score_cvss = 0.0;
    var image;

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(162, 213, 114)',
        blue: 'rgb(54, 162, 235)'
    };

    var color = Chart.helpers.color;

    const centerText = {
        beforeDraw: function (chart) {
            const width = chart.width
            const height = chart.height
            const ctx = chart.ctx
            ctx.restore()
            const fontSize = (height / 114).toFixed(2)
            ctx.font = 'bold ' + fontSize + 'em sans-serif'
            ctx.textBaseline = 'middle'
            ctx.fillStyle = 'white'
            ctx.strokeStyle = 'black'
            const text = score_cvss
            const textX = Math.round((width - (ctx.measureText(text).width)) / 2 - 16)
            const textY = height / 2
            ctx.fillText(text, textX, textY)
            ctx.strokeText(text, textX, textY)
            ctx.save()
        }
    }

    var config = {
        type: 'radar',
        data: {
            labels: [
                "Integrity", "Availability", "Access vector", "Attack complexity", "Privileges required", "User interaction", "Scope", "Confidentiality"],
            datasets: [{
                label: "Score",
                backgroundColor: color(window.chartColors.green).alpha(0.2).rgbString(),
                borderColor: window.chartColors.green,
                pointBackgroundColor: window.chartColors.green,
                data: [1, 1, 1, 1, 1, 1, 1, 1],
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'CVSS Score'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                r: {
                    min: -1,
                    max: 2,
                    ticks: {
                        display: false,
                        stepSize: 1
                    }
                }
            }
        },
        plugins: [centerText]
    };

    var myRadar;

    window.onload = function () {
        myRadar = new Chart(document.getElementById("canvas"), config);
    };
    var colorNames = Object.keys(window.chartColors);

    function download() {
        var a = document.createElement("a");
        a.href = myRadar.toBase64Image();
        a.download = "Image.png";
        a.click();
    }
</script>
<body>
<div id="segment_id">
    {% include 'menu.html' %}
    {% if external_js %}
        <script src="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.js"></script>
    {% else %}
        <script src="/static/js/cvss.js"></script>
    {% endif %}
    {% if external_css %}
        <link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.css">
    {% else %}
        <link rel="stylesheet" type="text/css" media="all" href="/static/css/cvss.css">
    {% endif %}
    <script>
        $(function () {
            $('.message .close')
                .on('click', function () {
                    $(this)
                        .closest('.message')
                        .transition('fade')
                    ;
                });


            $('.ui.dropdown.selection').dropdown({});


            $('.menu .item').tab({
                history: true,
                historyType: 'hash'
            });

            $('.ui.dropdown.selection').dropdown({});
        });
    </script>
    <style>
        .ui.dropdown .menu {
            min-width: 100%;
        }

        .ui.dropdown.dropdown .menu > .input {
            min-width: 80%;
        }
    </style>
    <div class="ui grid">
        <div class="ui column" style="width: 75px; padding-top: 50px;">
            {% include 'project/sidebar.html' %}
        </div>

        <script>
            fields_array = ['#v_name',
                '#v_descr',
                '#v_fix',
                '#v_url',
                '#v_cve',
                '#v_param',
                '#v_technical',
                '#v_risks',
                '#v_references',
                '#v_intruder'];
            fields_vals = [];


            var first = 1;

            function update_fields() {
                template_vars = document.querySelectorAll('[id=template_var]');

                for (var x = 0; x < fields_array.length; x++) {
                    obj = $(fields_array[x])[0];

                    if (first === 1) {
                        if (x === (fields_array.length - 1)) {
                            first = 0;
                        }
                        fields_vals.push(obj.value.toString());
                    }

                    obj_value = fields_vals[x];

                    for (var i = 0; i < template_vars.length; i++) {
                        variable_obj = template_vars[i];
                        variable_name = variable_obj.querySelectorAll('[id=template_name]')[0].value;
                        variable_name = '__' + variable_name + '__';
                        variable_value = variable_obj.querySelectorAll('[id=template_value]')[0].value.toString();

                        obj_value = obj_value.replace(variable_name, variable_value);
                    }

                    obj.value = obj_value;

                }

                obj = $('#v_name')[0];
                $('#issue_header')[0].innerText = 'Issue: ' + obj.value;
            }

            $(function () {
                // add additional fields
                add_fields = document.querySelectorAll('.additional_field');
                for (var x = 0; x < add_fields.length; x++) {
                    fields_array.push('#' + add_fields[x].id);
                }

                update_fields();


                document.querySelectorAll('[id=template_value]').forEach(item => {
                    item.addEventListener('input', event => {
                        update_fields();
                    })
                })

            });
        </script>

        <div class="ui column" style="width: calc(100% - 75px)">
            <h1 class="ui dividing header">Create new issue from template: {{ (current_template['tpl_name']) }}</h1>
            <div class="ui grid" style="width: 95%; padding-left: 15px; padding-top: 15px;">
                <div class="five wide column">
                    <form class="ui form" enctype="multipart/form-data" method="post" action="/project/{{ current_project['id'] }}/issue_template/{{ current_template['id'] }}/"
                          style="margin-top: 15px; width: 100%" id="new_issue_form" onsubmit="canva_to_b64('new_issue_form')" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <h3 class="ui header">You need to fill this variables:</h3>
                        {% set variables = json_unpack(current_template['variables']) %}
                        <div style="overflow: auto; height: 400px; width: 450px;">
                            {% for variable_name in variables %}
                                <div class="ui field" style="width: 90%" id="template_var">
                                    <h4>{{ (variable_name) }} ({{ (variables[variable_name]['type']) }})</h4>
                                    <input type="hidden" name="variable_name" id="template_name" value="{{ (variable_name) }}">
                                    <input type="hidden" name="variable_type" value="{{ (variables[variable_name]['type']) }}">
                                    <div class="field">
                                        <div class="ui input" style="max-width: 400px;">
                                            <input id="template_value" type="{% if variables[variable_name]['type'] == 'text' %}text{% else %}number{% endif %}" placeholder="Default value" onchange="update_fields();" name="variable_value"
                                                   value="{% if variables[variable_name]['type'] == 'text' %}{{ (variables[variable_name]['value']) }}{% else %}{{ variables[variable_name]['value'] | int }}{% endif %}">
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="submit" class="ui blue button" style="margin-top: 10px;">
                            <i class="plus icon"></i> Create
                        </button>
                    </form>
                </div>
                <div class="eleven wide column" style="border: 4px dashed green;">
                    <h1 class="ui dividing header" id="issue_header">Issue: {{ (current_template['name']) }}</h1>
                    <div class="ui top attached tabular menu" style="margin-bottom: 10px">
                        <a class="item active" data-tab="info">
                            Issue information
                        </a>
                        <a class="item" data-tab="fields">
                            Additional fields
                        </a>
                    </div>
                    <div class="ui tab active" data-tab="info">
                        <form class="ui form" style="margin-top: 15px; width: 100%">
                            <div class="ui grid" style="width: 100%">
                                <div class="eight wide column">
                                    <div class="ui container" style="width: 90%; float: left;">
                                        <div class="ui field">
                                            <div class="ui labeled input">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="at icon"></i>Name:
                                                </div>
                                                <input type="text" name="name" id="v_name" placeholder="SQL injection.." readonly value="{{ (current_template['name']) }}">
                                            </div>
                                        </div>
                                        <div class="ui field">
                                            <div class="ui labeled input">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="sticky note outline icon"></i>Description:
                                                </div>
                                                <textarea rows="5" name="description" id="v_descr" placeholder="Vulnerability description" readonly>{{ (current_template['description']) }}</textarea>
                                            </div>
                                        </div>
                                        <div class="ui field">
                                            <div class="ui labeled input">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="cog icon"></i>Reproduce:
                                                </div>
                                                <textarea rows="8" name="technical"
                                                          placeholder="Technical information about issue" id="v_technical" readonly>{{ (current_template['technical']) }}</textarea>
                                            </div>
                                        </div>
                                        <div class="ui field">
                                            <div class="ui labeled input">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="exclamation triangle icon"></i>Impact:
                                                </div>
                                                <textarea rows="3" name="risks" placeholder="Issue exploitation risks" id="v_risks" readonly>{{ (current_template['risks']) }}</textarea>
                                            </div>
                                        </div>
                                        <div class="ui field">
                                            <div class="ui labeled input">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="medkit icon"></i>Fix:
                                                </div>
                                                <textarea rows="3" name="fix"
                                                          placeholder="To fix this vulnerability you need..." id="v_fix" readonly>{{ (current_template['fix']) }}</textarea>
                                            </div>
                                        </div>
                                        <div class="ui field">
                                            <div class="ui labeled input" style="z-index: 1000;">
                                                <div class="ui label" style="width: 130px;">
                                                    <i class="linkify icon"></i>OWASP references:
                                                </div>
                                                <div class="ui fluid selection dropdown search multiple disabled" id="references">
                                                    <input type="hidden" name="references" required
                                                    value="{{ (current_template['references']) }}" readonly>
                                                    <i class="dropdown icon"></i>
                                                    <div class="default text">Select OWASP references</div> 
                                                    <div class="menu">
                                                        <div class="item" data-value="Search Engine Discovery Reconnaissance for Information Leakage (WSTG-INFO-01)">Search Engine Discovery Reconnaissance for Information Leakage (WSTG-INFO-01)</div>
                                                        <div class="item" data-value="Fingerprint Web Server (WSTG-INFO-02)">Fingerprint Web Server (WSTG-INFO-02)</div>
                                                        <div class="item" data-value="Webserver Metafiles for Information Leakage (WSTG-INFO-03)">Webserver Metafiles for Information Leakage (WSTG-INFO-03)</div>
                                                        <div class="item" data-value="Enumerate Applications on Webserver (WSTG-INFO-04)">Enumerate Applications on Webserver (WSTG-INFO-04)</div>
                                                        <div class="item" data-value="Webpage Content for Information Leakage (WSTG-INFO-05)">Webpage Content for Information Leakage (WSTG-INFO-05)</div>
                                                        <div class="item" data-value="Identify Application Entry Points (WSTG-INFO-06)">Identify Application Entry Points (WSTG-INFO-06)</div>
                                                        <div class="item" data-value="Map Execution Paths Through Application (WSTG-INFO-07)">Map Execution Paths Through Application (WSTG-INFO-07)</div>
                                                        <div class="item" data-value="Fingerprint Web Application Framework (WSTG-INFO-08)">Fingerprint Web Application Framework (WSTG-INFO-08)</div>
                                                        <div class="item" data-value="Fingerprint Web Application (WSTG-INFO-09)">Fingerprint Web Application (WSTG-INFO-09)</div>
                                                        <div class="item" data-value="Map Application Architecture (WSTG-INFO-10)">Map Application Architecture (WSTG-INFO-10)</div>
                                                        <div class="item" data-value="Network Infrastructure Configuration (WSTG-CONF-01)">Network Infrastructure Configuration (WSTG-CONF-01)</div>
                                                        <div class="item" data-value="Application Platform Configuration (WSTG-CONF-02)">Application Platform Configuration (WSTG-CONF-02)</div>
                                                        <div class="item" data-value="File Extensions Handling for Sensitive Information (WSTG-CONF-03)">File Extensions Handling for Sensitive Information (WSTG-CONF-03)</div>
                                                        <div class="item" data-value="Old Backup and Unreferenced Files for Sensitive Information (WSTG-CONF-04)">Old Backup and Unreferenced Files for Sensitive Information (WSTG-CONF-04)</div>
                                                        <div class="item" data-value="Enumerate Infrastructure and Application Admin Interfaces (WSTG-CONF-05)">Enumerate Infrastructure and Application Admin Interfaces (WSTG-CONF-05)</div>
                                                        <div class="item" data-value="HTTP Methods (WSTG-CONF-06)">HTTP Methods (WSTG-CONF-06)</div>
                                                        <div class="item" data-value="HTTP Strict Transport Security (WSTG-CONF-07)">HTTP Strict Transport Security (WSTG-CONF-07)</div>
                                                        <div class="item" data-value="RIA Cross Domain Policy (WSTG-CONF-08)">IA Cross Domain Policy (WSTG-CONF-08)</div>
                                                        <div class="item" data-value="File Permission (WSTG-CONF-09)">File Permission (WSTG-CONF-09)</div>
                                                        <div class="item" data-value="Subdomain Takeover (WSTG-CONF-10)">Subdomain Takeover (WSTG-CONF-10)</div>
                                                        <div class="item" data-value="Cloud Storage (WSTG-CONF-11)">Cloud Storage (WSTG-CONF-11)</div>
                                                        <div class="item" data-value="Role Definitions (WSTG-IDNT-01)">Role Definitions (WSTG-IDNT-01)</div>
                                                        <div class="item" data-value="User Registration Process (WSTG-IDNT-02)">User Registration Process (WSTG-IDNT-02)</div>
                                                        <div class="item" data-value="Account Provisioning Process (WSTG-IDNT-03)">Account Provisioning Process (WSTG-IDNT-03)</div>
                                                        <div class="item" data-value="Account Enumeration and Guessable User Account (WSTG-IDNT-04)">Account Enumeration and Guessable User Account (WSTG-IDNT-04)</div>
                                                        <div class="item" data-value="Weak or Unenforced Username Policy (WSTG-IDNT-05)">Weak or Unenforced Username Policy (WSTG-IDNT-05)</div>
                                                        <div class="item" data-value="Credentials Transported over an Encrypted Channel (WSTG-ATHN-01)">Credentials Transported over an Encrypted Channel (WSTG-ATHN-01)</div>
                                                        <div class="item" data-value="Default Credentials (WSTG-ATHN-02)">Default Credentials (WSTG-ATHN-02)</div>
                                                        <div class="item" data-value="Weak Lock Out Mechanism (WSTG-ATHN-03)">Weak Lock Out Mechanism (WSTG-ATHN-03)</div>
                                                        <div class="item" data-value="Bypassing Authentication Schema (WSTG-ATHN-04)">Bypassing Authentication Schema (WSTG-ATHN-04)</div>
                                                        <div class="item" data-value="Vulnerable Remember Password (WSTG-ATHN-05)">Vulnerable Remember Password (WSTG-ATHN-05)</div>
                                                        <div class="item" data-value="Browser Cache Weaknesses (WSTG-ATHN-06)">Browser Cache Weaknesses (WSTG-ATHN-06)</div>
                                                        <div class="item" data-value="Weak Password Policy (WSTG-ATHN-07)">Weak Password Policy (WSTG-ATHN-07)</div>
                                                        <div class="item" data-value="Weak Security Question Answer (WSTG-ATHN-08)">Weak Security Question Answer (WSTG-ATHN-08)</div>
                                                        <div class="item" data-value="Weak Password Change or Reset Functionalities (WSTG-ATHN-09)">Weak Password Change or Reset Functionalities (WSTG-ATHN-09)</div>
                                                        <div class="item" data-value="Weaker Authentication in Alternative Channel (WSTG-ATHN-10)">Weaker Authentication in Alternative Channel (WSTG-ATHN-10)</div>
                                                        <div class="item" data-value="Directory Traversal File Include (WSTG-ATHZ-01)">Directory Traversal File Include (WSTG-ATHZ-01)</div>
                                                        <div class="item" data-value="Bypassing Authorization Schema (WSTG-ATHZ-02)">Bypassing Authorization Schema (WSTG-ATHZ-02)</div>
                                                        <div class="item" data-value="Privilege Escalation (WSTG-ATHZ-03)">Privilege Escalation (WSTG-ATHZ-03)</div>
                                                        <div class="item" data-value="Insecure Direct Object References (WSTG-ATHZ-04)">Insecure Direct Object References (WSTG-ATHZ-04)</div>
                                                        <div class="item" data-value="Session Management Schema (WSTG-SESS-01)">Session Management Schema (WSTG-SESS-01)</div>
                                                        <div class="item" data-value="Cookies Attributes (WSTG-SESS-02)">Cookies Attributes (WSTG-SESS-02)</div>
                                                        <div class="item" data-value="Session Fixation (WSTG-SESS-03)">Session Fixation (WSTG-SESS-03)</div>
                                                        <div class="item" data-value="Exposed Session Variables (WSTG-SESS-04)">Exposed Session Variables (WSTG-SESS-04)</div>
                                                        <div class="item" data-value="Cross Site Request Forgery (WSTG-SESS-05)">Cross Site Request Forgery (WSTG-SESS-05)</div>
                                                        <div class="item" data-value="Logout Functionality (WSTG-SESS-06)">Logout Functionality (WSTG-SESS-06)</div>
                                                        <div class="item" data-value="Session Timeout (WSTG-SESS-07)">Session Timeout (WSTG-SESS-07)</div>
                                                        <div class="item" data-value="Session Puzzling (WSTG-SESS-08)">Session Puzzling (WSTG-SESS-08)</div>
                                                        <div class="item" data-value="Session Hijacking (WSTG-SESS-09)">Session Hijacking (WSTG-SESS-09)</div>
                                                        <div class="item" data-value="Reflected Cross Site Scripting (WSTG-INPV-01)">Reflected Cross Site Scripting (WSTG-INPV-01)</div>
                                                        <div class="item" data-value="Stored Cross Site Scripting (WSTG-INPV-02)">Stored Cross Site Scripting (WSTG-INPV-02)</div>
                                                        <div class="item" data-value="HTTP Verb Tampering (WSTG-INPV-03)">HTTP Verb Tampering (WSTG-INPV-03)</div>
                                                        <div class="item" data-value="HTTP Parameter Pollution (WSTG-INPV-04)">HTTP Parameter Pollution (WSTG-INPV-04)</div>
                                                        <div class="item" data-value="SQL Injection (WSTG-INPV-05)">SQL Injection (WSTG-INPV-05)</div>
                                                        <div class="item" data-value="LDAP Injection (WSTG-INPV-06)">LDAP Injection (WSTG-INPV-06)</div>
                                                        <div class="item" data-value="XML Injection (WSTG-INPV-07)">XML Injection (WSTG-INPV-07)</div>
                                                        <div class="item" data-value="SSI Injection (WSTG-INPV-08)">SSI Injection (WSTG-INPV-08)</div>
                                                        <div class="item" data-value="XPath Injection (WSTG-INPV-09)">XPath Injection (WSTG-INPV-09)</div>
                                                        <div class="item" data-value="IMAP SMTP Injection (WSTG-INPV-10)">IMAP SMTP Injection (WSTG-INPV-10)</div>
                                                        <div class="item" data-value="Code Injection (WSTG-INPV-11)">Code Injection (WSTG-INPV-11)</div>
                                                        <div class="item" data-value="Command Injection (WSTG-INPV-12)">Command Injection (WSTG-INPV-12)</div>
                                                        <div class="item" data-value="Format String Injection (WSTG-INPV-13)">Format String Injection (WSTG-INPV-13)</div>
                                                        <div class="item" data-value="Incubated Vulnerability (WSTG-INPV-14)">Incubated Vulnerability (WSTG-INPV-14)</div>
                                                        <div class="item" data-value="HTTP Splitting Smuggling (WSTG-INPV-15)">HTTP Splitting Smuggling (WSTG-INPV-15)</div>
                                                        <div class="item" data-value="HTTP Incoming Requests (WSTG-INPV-16)">HTTP Incoming Requests (WSTG-INPV-16)</div>
                                                        <div class="item" data-value="Host Header Injection (WSTG-INPV-17)">Host Header Injection (WSTG-INPV-17)</div>
                                                        <div class="item" data-value="Server-side Template Injection (WSTG-INPV-18)">Server-side Template Injection (WSTG-INPV-18)</div>
                                                        <div class="item" data-value="Server-Side Request Forgery (WSTG-INPV-19)">Server-Side Request Forgery (WSTG-INPV-19)</div>
                                                        <div class="item" data-value="Improper Error Handling (WSTG-ERRH-01)">Improper Error Handling (WSTG-ERRH-01)</div>
                                                        <div class="item" data-value="Stack Traces (WSTG-ERRH-02)">Stack Traces (WSTG-ERRH-02)</div>
                                                        <div class="item" data-value="Weak Transport Layer Security (WSTG-CRYP-01)">Weak Transport Layer Security (WSTG-CRYP-01)</div>
                                                        <div class="item" data-value="Padding Oracle (WSTG-CRYP-02)">Padding Oracle (WSTG-CRYP-02)</div>
                                                        <div class="item" data-value="Sensitive Information Sent via Unencrypted Channels (WSTG-CRYP-03)">Sensitive Information Sent via Unencrypted Channels (WSTG-CRYP-03)</div>
                                                        <div class="item" data-value="Weak Encryption (WSTG-CRYP-04)">Weak Encryption (WSTG-CRYP-04)</div>
                                                        <div class="item" data-value="Business Logic Data Validation (WSTG-BUSL-01)">Business Logic Data Validation (WSTG-BUSL-01)</div>
                                                        <div class="item" data-value="Ability to Forge Requests (WSTG-BUSL-02)">Ability to Forge Requests (WSTG-BUSL-02)</div>
                                                        <div class="item" data-value="Integrity Checks (WSTG-BUSL-03)">Integrity Checks (WSTG-BUSL-03)</div>
                                                        <div class="item" data-value="Process Timing (WSTG-BUSL-04)">Process Timing (WSTG-BUSL-04)</div>
                                                        <div class="item" data-value="Number of Times a Function Can Be Used Limits (WSTG-BUSL-05)">Number of Times a Function Can Be Used Limits (WSTG-BUSL-05)</div>
                                                        <div class="item" data-value="Circumvention of Work Flows (WSTG-BUSL-06)">Circumvention of Work Flows (WSTG-BUSL-06)</div>
                                                        <div class="item" data-value="Defenses Against Application Misuse (WSTG-BUSL-07)">Defenses Against Application Misuse (WSTG-BUSL-07)</div>
                                                        <div class="item" data-value="Upload of Unexpected File Types (WSTG-BUSL-08)">Upload of Unexpected File Types (WSTG-BUSL-08)</div>
                                                        <div class="item" data-value="Upload of Malicious Files (WSTG-BUSL-09)">Upload of Malicious Files (WSTG-BUSL-09)</div>
                                                        <div class="item" data-value="DOM-Based Cross Site Scripting (WSTG-CLNT-01)">DOM-Based Cross Site Scripting (WSTG-CLNT-01)</div>
                                                        <div class="item" data-value="JavaScript Execution (WSTG-CLNT-02)">JavaScript Execution (WSTG-CLNT-02)</div>
                                                        <div class="item" data-value="HTML Injection (WSTG-CLNT-03)">HTML Injection (WSTG-CLNT-03)</div>
                                                        <div class="item" data-value="Client-side URL Redirect (WSTG-CLNT-04)">Client-side URL Redirect (WSTG-CLNT-04)</div>
                                                        <div class="item" data-value="CSS Injection (WSTG-CLNT-05)">CSS Injection (WSTG-CLNT-05)</div>
                                                        <div class="item" data-value="Client-side Resource Manipulation (WSTG-CLNT-06)">Client-side Resource Manipulation (WSTG-CLNT-06)</div>
                                                        <div class="item" data-value="Cross Origin Resource Sharing (WSTG-CLNT-07)">Cross Origin Resource Sharing (WSTG-CLNT-07)</div>
                                                        <div class="item" data-value="Cross Site Flashing (WSTG-CLNT-08)">Cross Site Flashing (WSTG-CLNT-08)</div>
                                                        <div class="item" data-value="Clickjacking (WSTG-CLNT-09)">Clickjacking (WSTG-CLNT-09)</div>
                                                        <div class="item" data-value="WebSockets (WSTG-CLNT-10)">WebSockets (WSTG-CLNT-10)</div>
                                                        <div class="item" data-value="Web Messaging (WSTG-CLNT-11)">Web Messaging (WSTG-CLNT-11)</div>
                                                        <div class="item" data-value="Browser Storage (WSTG-CLNT-12)">Browser Storage (WSTG-CLNT-12)</div>
                                                        <div class="item" data-value="Cross Site Script Inclusion (WSTG-CLNT-13)">Cross Site Script Inclusion (WSTG-CLNT-13)</div>
                                                        <div class="item" data-value="GraphQL (WSTG-APIT-01)">GraphQL (WSTG-APIT-01)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="eight wide column">
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label">
                                                <i class="folder open icon"></i>URL path/service:
                                            </div>
                                            <input type="text" id="v_url" name="url" placeholder="/admin/"
                                                   value="{{ (current_template['url_path']) }}" readonly>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input" style="margin: 0 0 1em;">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="hashtag icon"></i>CVSS:
                                            </div>
                                            <input type="number" id="origin_cvss" name="cvss" step="0.01" min="0" max="10" placeholder="10.0"
                                                   value="{{ (current_template['cvss']) }}" readonly>
                                        </div>
                                        <div class="ui labeled input" style="margin: 0 0 1em;">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="hashtag icon"></i>Vector:
                                            </div>
                                            <input id="origin_cvss_vector" style="min-width: 350px;" type="text" name="cvss_vector" readonly="readonly"
                                                placeholder="CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N"
                                                value="{% if 'cvss_vector' in current_template %}{{ current_template['cvss_vector'] }}{% endif %}">     
                                        </div style="text-align: center;">
                                            <button disabled type="button" class="ui button blue">
                                                <i class="ui calculator icon"></i>CVSS calculator
                                            </button>
                                        </div>
                                    </div>
                                    <div id="cvss_hidden">
                                        <div class="ui divider"></div>
                                        <div style="display: none;" id="cvssboard">
                                        </div>
                                        <div id="chartjs-radar">
                                            <canvas id="canvas"></canvas>
                                        </div>
                                        <div class="ui divider"></div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="hashtag icon"></i>CVE:
                                            </div>
                                            <input type="text" name="cve" id="v_cve" placeholder="2020-1337"
                                                   value="{{ (current_template['cve']) }}" readonly>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="hashtag icon"></i>CWE:
                                            </div>
                                            <input type="number" name="cwe" placeholder="123"
                                                   value="{{ (current_template['cwe']) }}" readonly>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="question circle icon"></i>Status:
                                            </div>
                                            <div class="ui fluid selection dropdown disabled" id="services_list">
                                                <input type="hidden" name="status" required
                                                       value="{{ (current_template['status']) }}" readonly>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select status</div>
                                                <div class="menu">
                                                    <div class="item" data-value="PoC creation">PoC creation</div>
                                                    <div class="item" data-value="PoC available">PoC available</div>
                                                    <div class="item" data-value="Confirmed">Confirmed</div>
                                                    <div class="item" data-value="Wasn't Confirmed">Wasn't Confirmed</div>
                                                    <div class="item" data-value="Pending...">Pending...</div>
                                                    <div class="item" data-value="Need to check">Need to check</div>
                                                    <div class="item" data-value="Need to recheck">Need to recheck</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="exclamation triangle icon"></i>Criticality:
                                            </div>
                                            <div class="ui fluid selection dropdown disabled" id="services_list">
                                                <input type="hidden" name="criticality" required value="-1" readonly>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select criticality</div>
                                                <div class="menu">
                                                    <div class="item" data-value="-1">use CVSS criticality</div>
                                                    <div class="item" data-value="0"><i class="warning circle blue icon"></i>Information
                                                        (cvss=0.0)
                                                    </div>
                                                    <div class="item" data-value="2"><i class="warning circle green icon"></i>Low
                                                        (cvss=2.0)
                                                    </div>
                                                    <div class="item" data-value="5"><i class="warning circle yellow icon"></i>Medium
                                                        (cvss=5.0)
                                                    </div>
                                                    <div class="item" data-value="8"><i class="warning circle orange icon"></i>High
                                                        (cvss=8.0)
                                                    </div>
                                                    <div class="item" data-value="9.5"><i class="warning circle red icon"></i>Critical
                                                        (cvss=9.5)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="desktop icon"></i>Parameter:
                                            </div>
                                            <input type="text" id="v_param" name="param" placeholder="(GET) id=123"
                                                   value="{{ (current_template['param']) }}" readonly>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="desktop icon"></i>Type:
                                            </div>
                                            <div class="ui fluid selection dropdown disabled" id="services_list">
                                                <input type="hidden" name="issue_type" required
                                                       value="{{ (current_template['type']) }}" readonly>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select type</div>
                                                <div class="menu">
                                                    <div class="item" data-value="vulnerability">Vulnerability</div>
                                                    <div class="item" data-value="remark">Remark</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 170px;">
                                                <i class="user secret icon"></i>Intruder:
                                            </div>
                                            <div class="ui fluid selection dropdown disabled" id="intruder_list">
                                                <input type="hidden" name="intruder" required
                                                    value="{{ (current_template['intruder']) }}" readonly>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select type</div>
                                                <div class="menu">
                                                    <div class="item" data-value="Noire">Noire</div>
                                                    <div class="item" data-value="Noire interne">Noire interne</div>
                                                    <div class="item" data-value="Grise">Grise</div>
                                                    <div class="item" data-value="Grise interne">Grise interne</div>
                                                    <div class="item" data-value="Blanche">Blanche</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="ui tab" data-tab="fields">
                        {% set fields = json_unpack(current_template['fields']) %}
                        <script>
                            $(document).ready(function () {
                                $('#new_field_dropdown').dropdown({});
                            });
                        </script>
                        <div class="ui grid">
                            <div class="two column row">
                                <div class="ui column">
                                    <h2 class="ui dividing header">Text fields</h2>
                                    <form class="ui form">
                                        <div id="fields_list">
                                            {% for field_name in fields %}
                                                {% if fields[field_name]['type'] != 'file' %}
                                                    <div>
                                                        <h4>{{ (field_name) }} ({{ fields[field_name]['type'] }})</h4>
                                                        <input type="hidden" name="additional_field_name" value="{{ (field_name) }}">
                                                        <input type="hidden" name="additional_field_type" value="{{ fields[field_name]['type'] }}">
                                                        <div class="ui two fields">
                                                            <div class="field">
                                                                <div class="ui input">
                                                                    {% if fields[field_name]['type'] == 'text' %}
                                                                        <input type="text" id="additional_field-{{ (field_name) }}" class="additional_field" readonly value="{{ (fields[field_name]['value']) }}" placeholder="Field value" name="additional_field_value">
                                                                    {% elif fields[field_name]['type'] == 'float' %}
                                                                        <input type="number" readonly step="any" value="{{ fields[field_name]['value'] | float }}" placeholder="Field value" name="additional_field_value">
                                                                    {% else %}
                                                                        <input type="number" readonly value="{{ fields[field_name]['value'] | int }}" placeholder="Field value" name="additional_field_value">
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="field">
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <div class="divider"></div>
                                    </form>
                                </div>

                                <div class="ui column">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'footer.html' %}
</div>
</div>
</body>
<script>

    function canva_to_b64(id) {
        var cvss_image = myRadar.toBase64Image();
        var myForm = document.getElementById(id);
        var element = document.createElement("input");
        element.setAttribute("type", "text");
        element.setAttribute("style", "display: none")
        element.setAttribute("value", cvss_image);
        element.setAttribute("name", "cvss_graph");
        myForm.appendChild(element)
    }
    
    var c1 = new CVSS("cvssboard", {
        onchange: function () {
            c1.vector.setAttribute('href', '#' + c1.get().vector)
            document.getElementById('origin_cvss').value = c1.get().score;
            document.getElementById('origin_cvss_vector').value = c1.get().vector;
            action()
        }
    });

    cvss_vector = '{% if 'cvss_vector' in current_template %}{{ current_template['cvss_vector'] }}{% else %}CVSS:3.1/AV:P/AC:H/PR:H/UI:R/S:U/C:N/I:N/A:N{% endif %}';
    if (cvss_vector !== '') {
        c1.set(cvss_vector);
    }
    
    
    
    function action() {
        var tmp = c1.get().vector.split("/");
        var score = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        var radar_point = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        for (let index = 1; index < tmp.length; index++) {
            var type = tmp[index].split(":")[0];
            var selection = tmp[index].split(":")[1];
            switch (type) {
                case "AV":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "A":
                            score[type] = 0.62;
                            radar_point[type] = 1;
                            break;
                        case "L":
                            score[type] = 0.55;
                            radar_point[type] = 0;
                            break;
                        case "P":
                            score[type] = 0.2;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "AC":
                    switch (selection) {
                        case "H":
                            score[type] = 0.44;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.77;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;
                case "PR":
                    switch (selection) {
                        case "N":
                            score[type] = "N";
                            radar_point["PR"] = 2;
                            break;
                        case "L":
                            score[type] = "L";
                            radar_point["PR"] = 1;
                            break;
                        case "H":
                            score[type] = "H";
                            radar_point["PR"] = 0;
                            break;
                        default:
                            break;
                    }
                case "UI":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "R":
                            score[type] = 0.62;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "S":
                    switch (selection) {
                        case "U":
                            score[type] = 6.42;
                            radar_point[type] = 0;
                            break;
                        case "C":
                            score[type] = 7.52;
                            radar_point[type] = 2;
                        default:
                            break;
                    }
                    break;
                case "C":
                case "I":
                case "A":
                    switch (selection) {
                        case "N":
                            score[type] = 0.0;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.22;
                            radar_point[type] = 1;
                            break;
                        case "H":
                            score[type] = 0.56;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;        
                default:
                    break;
            }       
        }

        if (score["S"] == 6.42) {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score["PR"] = 0.62;
                    break;
                case "H":
                    score["PR"] = 0.27;
                    break;
                default:
                    break;
            } 
        }
        else {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score["PR"] = 0.68;
                    break;
                case "H":
                    score["PR"] = 0.5;
                    break;
                default:
                    break;
            }
        }


        var impact = 1 - (1 - score["C"]) * (1 - score["I"]) * (1 - score["A"])
        if (score["S"] == 6.42) {
            impact =  6.42 * impact;
        }
        else {
            impact = 7.52 * (impact - 0.029) - 3.25 * Math.pow((impact - 0.02), 15);
        }

        var exploitability = 8.22 * score["AV"] * score["AC"] * score["PR"] * score["UI"];


        impact = Math.round(impact*10)/10

        if (impact <= 2.5) {
            impact = "Mineur"
        } 
        else if (impact > 2.5 && impact <= 4) {
            impact = "Important"
        }
        else if (impact > 4 && impact <= 5.5 ){
            impact = "Majeur"
        }
        else {
            impact = "Critique"
        }

        
        exploitability = Math.round(exploitability*10)/10

        if (score["S"] == 6.42 && exploitability == 4) {
            exploitability = exploitability - 1
        }

        virt_exploitability = exploitability

        if (exploitability <= 1) {
            exploitability = "Difficile"
        } 
        else if (exploitability > 1 && exploitability <= 2) {
            exploitability = "Elevee"
        } 
        else if (exploitability > 2 && exploitability <= 3) {
            exploitability = "Moyen"
        }
        else {
            exploitability = "Facile"
        }

        const risk_matrix = {
            "Mineur": {"Difficile": "Mineur", "Elevee": "Mineur", "Moyen": "Important", "Facile": "Important"},
            "Important": {"Difficile": "Mineur", "Elevee": "Important", "Moyen": "Important", "Facile": "Majeur"},
            "Majeur": {"Difficile": "Important", "Elevee": "Important", "Moyen": "Majeur", "Facile": "Critique"},
            "Critique": {"Difficile": "Important", "Elevee": "Majeur", "Moyen": "Critique", "Facile": "Critique"}
        } 
        
        var risk = risk_matrix[impact][exploitability]

        var myForm = document.getElementById("new_issue_form");
        var element_impact = document.getElementsByName("impact")[0];
        var element_exploitability = document.getElementsByName("exploitability")[0];
        var element_risk = document.getElementsByName("risk")[0];
        

        if (element_impact) {
            element_impact.setAttribute("value", impact);
        }
        else {
            var element_impact = document.createElement("input");
            element_impact.setAttribute("type", "hidden");
            element_impact.setAttribute("value", impact);
            element_impact.setAttribute("name", "impact");
            myForm.appendChild(element_impact);
        }

        if (element_exploitability) {
            element_exploitability.setAttribute("value", exploitability);
        }
        else {
            var element_exploitability = document.createElement("input");
            element_exploitability.setAttribute("type", "hidden");
            element_exploitability.setAttribute("value", exploitability);
            element_exploitability.setAttribute("name", "exploitability");
            myForm.appendChild(element_exploitability);
        }
        
        if (element_risk) {
            element_risk.setAttribute("value", risk);
        }
        else {
            var element_risk = document.createElement("input");
            element_risk.setAttribute("type", "hidden");
            element_risk.setAttribute("value", risk);
            element_risk.setAttribute("name", "risk");
            myForm.appendChild(element_risk);
        }

        score_cvss = c1.get().score;

        config.data.datasets[0].data[0] = radar_point["I"];
        config.data.datasets[0].data[1] = radar_point["A"];
        config.data.datasets[0].data[2] = radar_point["AV"];
        config.data.datasets[0].data[3] = radar_point["AC"];
        config.data.datasets[0].data[4] = radar_point["PR"];
        config.data.datasets[0].data[5] = radar_point["UI"];
        config.data.datasets[0].data[6] = radar_point["S"];
        config.data.datasets[0].data[7] = radar_point["C"];

        if (score_cvss <= 3.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.green).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.green,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.green
        }
        else if (score_cvss >= 4 && score_cvss <= 6.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.yellow).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.yellow,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.yellow
        }
        else if (score_cvss >= 7 && score_cvss <= 8.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.orange).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.orange,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.orange
        }
        else {
            config.data.datasets[0].backgroundColor = color(window.chartColors.red).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.red,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.red
        }

        if (score["S"] == 6.42) {
            exploitability = virt_exploitability + 1
        }

        if (exploitability <= 1) {
            exploitability = "Difficile"
        } 
        else if (exploitability > 1 && exploitability <= 2) {
            exploitability = "Elevee"
        } 
        else if (exploitability > 2 && exploitability <= 3) {
            exploitability = "Moyen"
        }
        else {
            exploitability = "Facile"
        }

        if (element_exploitability) {
            element_exploitability.setAttribute("value", exploitability);
        }

        myRadar.update()

    }
    </script>
</html>
