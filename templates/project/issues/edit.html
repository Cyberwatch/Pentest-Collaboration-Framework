<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
{% set issue_fields = json_unpack(current_issue['fields']) %}
<style>
    #canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        width: 25em !important;
        height: 25em !important;
        margin: auto;
    }
    
    #chartjs-tooltip {
        opacity: 1;
        position: absolute;
        background: rgba(0, 0, 0, .7);
        color: white;
        border-radius: 3px;
        -webkit-transition: all .1s ease;
        transition: all .1s ease;
        pointer-events: none;
        -webkit-transform: translate(-50%, 0);
        transform: translate(-50%, 0);
    }

    .chartjs-tooltip-key {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 10px;
    }
</style>
<script src=https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js></script>
<script>
    var score_cvss = 0.0;
    var image;

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(162, 213, 114)',
        blue: 'rgb(54, 162, 235)'
    };

    var color = Chart.helpers.color;

    const centerText = {
        beforeDraw: function (chart) {
            const width = chart.width
            const height = chart.height
            const ctx = chart.ctx
            ctx.restore()
            const fontSize = (height / 114).toFixed(2)
            ctx.font = 'bold ' + fontSize + 'em sans-serif'
            ctx.textBaseline = 'middle'
            ctx.fillStyle = 'white'
            ctx.strokeStyle = 'black'
            const text = score_cvss
            const textX = Math.round((width - (ctx.measureText(text).width)) / 2 - 16)
            const textY = height / 2
            ctx.fillText(text, textX, textY)
            ctx.strokeText(text, textX, textY)
            ctx.save()
        }
    }

    var config = {
        type: 'radar',
        data: {
            labels: [
                "Integrity", "Availability", "Access vector", "Attack complexity", "Privileges required", "User interaction", "Scope", "Confidentiality"],
            datasets: [{
                label: "Score",
                backgroundColor: color(window.chartColors.green).alpha(0.2).rgbString(),
                borderColor: window.chartColors.green,
                pointBackgroundColor: window.chartColors.green,
                data: [1, 1, 1, 1, 1, 1, 1, 1],
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'CVSS Score'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                r: {
                    min: -1,
                    max: 2,
                    ticks: {
                        display: false,
                        stepSize: 1
                    }
                }
            }
        },
        plugins: [centerText]
    };

    var myRadar;

    window.onload = function () {
        myRadar = new Chart(document.getElementById("canvas"), config);
    };
    var colorNames = Object.keys(window.chartColors);

    function download() {
        var a = document.createElement("a");
        a.href = myRadar.toBase64Image();
        a.download = "Image.png";
        a.click();
    }
</script>

<body>
    <div id="segment_id">
        {% include 'menu.html' %}
        {% if external_js %}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.js"></script>
        {% else %}
        <script src="/static/js/sweetalert.min.js"></script>
        <script src="/static/js/cvss.js"></script>
        {% endif %}
        {% if external_css %}
        <link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.csss">
        <link rel="stylesheet" type="text/css" media="all"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.3/css/bootstrap.min.css">
        <style>
            /* OWASP RISK CSS */
            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap');

            * {
                box-sizing: border-box;
            }

            .classCritical {
                color: #FFFFFF;
                background-color: rgb(255, 102, 255, 0.5);
                font-weight: bold;
                border: 3px solid #FF66FF;
                border-radius: 5px;
            }

            .classHigh {
                color: #FFFFFF;
                background-color: rgba(255, 0, 0, 0.5);
                font-weight: bold;
                border: 3px solid #FF0000;
                border-radius: 5px;
            }

            .classMedium {
                color: #000000;
                background-color: rgba(255, 169, 0, 0.5);
                font-weight: bold;
                border: 3px solid #FFA900;
                border-radius: 5px;
            }

            .classLow {
                color: #000000;
                background-color: rgba(255, 255, 0, 0.5);
                font-weight: bold;
                border: 3px solid #FFFF00;
                border-radius: 5px;
            }

            .classNote {
                color: #000000;
                background-color: rgba(144, 238, 144, 0.5);
                font-weight: bold;
                border: 3px solid #90EE90;
                border-radius: 5px;
            }

            .risk {
                width: 400px;
                margin: 0 auto;
            }

            .riskChart {
                margin-bottom: 10px;
            }

            h1 {
                font-weight: bold;
            }

            section {
                padding: 10px;
            }

            .row {
                display: flex;
            }

            .row>section {
                flex: 1;
            }

            .nomargin {
                margin: 0;
            }
        </style>
        {% else %}
        <link rel="stylesheet" type="text/css" media="all" href="/static/css/cvss.css">
        <!--<link rel="stylesheet" type="text/css" media="all" href="/static/css/owasp_risc.css">-->
        <link rel="stylesheet" type="text/css" media="all" href="/static/css/bootstrap.css">
        {% endif %}

        <script>
            $(function () {
                $('.message .close')
                    .on('click', function () {
                        $(this)
                            .closest('.message')
                            .transition('fade')
                            ;
                    });


                $('.ui.dropdown.selection').dropdown({});

                // $('.ui.checkbox').checkbox();
            });
            $(document).ready(function () {
                $('.menu .item').tab({
                    history: true,
                    historyType: 'hash'
                });
                $('#template_dropdown').dropdown({
                    match: 'text',
                    ignoreCase: true,
                    fullTextSearch: true
                });
            });

            function delete_prompt(func, message) {
                if (confirm(message))
                    return true;
                return false;
            };

            hljs.initHighlightingOnLoad();

            function list_ips(list_hosts, search_field) {
                list_elem = $('#host-port-list')[0];
                list_elem.innerHTML = '';
                var text_html = '';
                var shown_html = '';
                var count = 0;
                for (var i = 0; i < list_hosts.length; i++) {
                    s = list_hosts[i]['ip'];
                    if (list_hosts[i]['port'] !== 0) {
                        s += ':' + list_hosts[i]['port'];
                        if (list_hosts[i]['is_tcp']) {
                            s += '(tcp)';
                        } else {
                            s += '(udp)';
                        }
                    }
                    check_str = '';
                    if (list_hosts[i]['checked']) {
                        check_str = 'checked';
                    }
                    if (s.includes(search_field.toLowerCase()) || search_field === '') {

                        inner = `<div class="ui item checkbox" data-value="item1" id="ip_row" onclick="copy_host(this)">
                                <input type="checkbox" name="ip_port-${i}" value="${list_hosts[i]['port_id']}" ${check_str} onchange="switch_host('${list_hosts[i]['port_id']}','0')">
                                <label>${s}</label>
                            </div>`;
                        if (list_hosts[i]['checked']) {
                            shown_html += inner;
                        } else {
                            text_html += inner;
                            count += 1;
                        }
                    } else if (list_hosts[i]['checked']) {
                        inner = `<div class="ui item checkbox" data-value="item1" id="ip_row" style="display: none;" onclick="copy_host(this)">
                                <input type="checkbox" name="ip_port-${i}" value="${list_hosts[i]['port_id']}" checked>
                                <label>${s}</label>
                            </div>`;
                        shown_html += inner;
                    }
                }
                if (count > 1000) {
                    text_html = shown_html + `<div class="ui item" data-value="item1" id="ip_row">
                                <label>Too much results (${count})..</label>
                            </div>`;
                } else {
                    text_html = shown_html + text_html;
                }
                list_elem.innerHTML = text_html;

                $('#ip_row').checkbox(
                    {
                        beforeChecked: function (e) {
                            return false;
                        },
                        beforeUnchecked: function (e) {
                            return false;
                        }
                    }
                );

                //$('.ui.checkbox').checkbox();

            }

            const copyToClipboard = str => {
                const el = document.createElement('textarea');
                el.value = str;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                $('body')
                    .toast({
                        class: 'success',
                        position: 'bottom left',
                        message: 'Host ' + str + ' copied!'
                    });
            };

            clickCount = 0;
            clickElem = '';

            function copy_host(obj) {
                clickCount++;
                setTimeout(() => {
                    if (clickCount === 2) {
                        // double click -> copy

                        copyToClipboard(obj.childNodes[3].innerText);
                    } else if (clickCount === 1) {
                        // single click -> change

                        v = obj.childNodes[1].value;
                        if (v.includes(":")) {
                            // hostname
                            var fields = v.split(':');
                            switch_host(fields[0], fields[1]);
                        } else {
                            // ip
                            switch_host(v, '0');
                        }
                        obj.childNodes[1].checked = !obj.childNodes[1].checked;
                    }
                    clickCount = 0;
                }, 250)
            }

            function list_hostnames(list_hosts, search_field) {
                list_elem = $('#hostname-port-list')[0];
                list_elem.innerHTML = '';
                var text_html = '';
                var shown_html = '';
                var count = 0;
                for (var i = 0; i < list_hosts.length; i++) {
                    s = list_hosts[i]['hostname'];
                    if (list_hosts[i]['port'] !== 0) {
                        s += ':' + list_hosts[i]['port'];
                        if (list_hosts[i]['is_tcp']) {
                            s += '(tcp)';
                        } else {
                            s += '(udp)';
                        }
                    }
                    check_str = '';
                    if (list_hosts[i]['checked']) {
                        check_str = 'checked';
                    }
                    if (s.includes(search_field.toLowerCase()) || search_field === '') {

                        inner = `<div class="ui item checkbox" data-value="item1" id="hostname_row"  onclick="copy_host(this)">
                                <input type="checkbox" name="host_port-${i}" value="${list_hosts[i]['port_id']}:${list_hosts[i]['hostname_id']}" ${check_str} onchange="switch_host('${list_hosts[i]['port_id']}','${list_hosts[i]['hostname_id']}')">
                                <label>${s}</label>
                            </div>`;
                        if (list_hosts[i]['checked']) {
                            shown_html += inner;
                        } else {
                            text_html += inner;
                            count += 1;
                        }
                    } else if (list_hosts[i]['checked']) {
                        inner = `<div class="ui item checkbox" data-value="item1" id="hostname_row" style="display: none;"  onclick="copy_host(this)">
                                <input type="checkbox" name="host_port-${i}" value="${list_hosts[i]['port_id']}:${list_hosts[i]['hostname_id']}" checked>
                                <label>${s}</label>
                            </div>`;
                        shown_html += inner;
                    }
                }
                if (count > 1000) {
                    text_html = shown_html + `<div class="ui item" data-value="item1" id="hostname_row">
                                <label>Too much results (${count})..</label>
                            </div>`;
                } else {
                    text_html = shown_html + text_html;
                }
                list_elem.innerHTML = text_html;

                $('#hostname_row').checkbox(
                    {
                        beforeChecked: function (e) {
                            return false;
                        },
                        beforeUnchecked: function (e) {
                            return false;
                        }
                    }
                );
                //$('.ui.checkbox').checkbox();

            }

            var ips = [];
            var hostnames = [];

            // add hosts
            $(document).ready(function () {
                $.getJSON("hosts_ports_list", function (j) {
                    ips = j.ips;
                    hostnames = j.hostnames;
                    list_ips(ips, '');
                    list_hostnames(hostnames, '');
                });


                input = $('#input_search_ip')[0];

                input.oninput = function () {
                    value = $('#input_search_ip')[0].value;
                    list_ips(ips, value);
                };

                input = $('#input_search_hostname')[0];

                input.oninput = function () {
                    value = $('#input_search_hostname')[0].value;
                    list_hostnames(hostnames, value);
                };
            });

            function switch_host(port_id, hostname_id) {
                if (hostname_id === '0') {
                    for (var i = 0; i < ips.length; i++) {
                        s = ips[i]['port_id'];
                        if (s === port_id) {
                            ips[i]['checked'] = !ips[i]['checked'];
                            return;
                        }
                    }
                } else {
                    for (var i = 0; i < hostnames.length; i++) {
                        port = hostnames[i]['port_id'];
                        hostname = hostnames[i]['hostname_id'];
                        if (port === port_id && hostname === hostname_id) {
                            hostnames[i]['checked'] = !hostnames[i]['checked'];
                            return;
                        }
                    }
                }
            }

            upload_list = [];


            file_counter = -1;

            max_files = 0;

            uploaded_files = 0;

            window.addEventListener("paste", function (e) {
                var items = Array.from(e.clipboardData.items);

                //var blob = item.getAsFile();
                var item_arr = [];

                for (let value of items) {
                    file_obj = value.getAsFile();
                    if (file_obj) {
                        item_arr.push(file_obj);
                    }
                }

                $('#poc_header')[0].innerText = "Upload PoC: 1 of " + item_arr.length;

                if (item_arr.length > 0) {
                    upload_list = item_arr;
                    file_counter = 0;
                    max_files = item_arr.length;
                    file_window();
                }
            });

            function file_window() {

                $('#poc_header')[0].innerText = "Upload PoC: " + (file_counter + 1) + " of " + upload_list.length;

                $('#send_file_button')[0].classList.remove("disabled");
                $('#next_file_button')[0].classList.remove("disabled");
                $('#poc_description')[0].classList.remove("disabled");
                $('#poc_service_list')[0].classList.remove("disabled");
                $('#poc_description_value')[0].value = '';
                $('#poc_service_value')[0].value = '0:0';
                $('#poc_filename')[0].value = upload_list[file_counter].name;
                $('#progress_bar')[0].style.display = 'none';

                $('.ui.modal')
                    .modal({
                        closable: false,
                        onDeny: function () {
                            poc_next();
                            return false;
                        },
                        onApprove: function () {
                            poc_upload();
                            return false;
                        }
                    })
                    .modal('show')
                    ;

                file_obj = upload_list[file_counter];

                filetype = file_obj.type;
                if (filetype.startsWith("image/")) {
                    $('#poc_img')[0].style.display = '';
                    $('#poc_txt')[0].style.display = 'none';
                    $('#poc_img')[0].src = URL.createObjectURL(file_obj);
                    $('#progress_bar')[0].style.display = 'none';

                } else if (filetype.startsWith("text/")) {
                    $('#poc_img')[0].style.display = 'none';
                    $('#poc_txt')[0].style.display = '';
                    read = new FileReader();

                    read.readAsBinaryString(file_obj);

                    read.onloadend = function () {
                        $('#poc_txt')[0].innerText = read.result;
                    }
                }
            }


            function poc_upload() {
                $('#send_file_button')[0].classList.add("disabled");
                $('#next_file_button')[0].classList.add("disabled");
                $('#poc_description')[0].classList.add("disabled");
                $('#poc_service_list')[0].classList.add("disabled");

                csrf = "{{ csrf_token() }}";


                var formData = new FormData();
                formData.append('file', upload_list[file_counter]);

                formData.append('comment', $('#poc_description_value')[0].value);
                formData.append('service', $('#poc_service_value')[0].value);
                formData.append('csrf_token', csrf);


                $.ajax({
                    xhr: function () {
                        var xhr = new window.XMLHttpRequest();
                        xhr.upload.addEventListener("progress", function (evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = ((evt.loaded / evt.total) * 100);
                                $('#progress_bar')[0].style.display = '';
                                $('#progress_bar').progress(
                                    {
                                        percent: percentComplete
                                    })
                            }
                        }, false);
                        return xhr;
                    },
                    url: "/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/new_poc",
                    type: 'POST',
                    data: formData,
                    processData: false,  // tell jQuery not to process the data
                    contentType: false,  // tell jQuery not to set contentType
                    success: function (data) {
                        uploaded_files += 1;
                        poc_next();
                    }
                });

            }

            function poc_next() {
                file_counter += 1;

                if (file_counter < upload_list.length) {
                    file_window();
                } else {
                    $('.ui.modal').modal('hide')
                    upload_list = [];
                    file_counter = -1;
                    max_files = 0;
                    if (uploaded_files) {
                        window.location.reload(false);
                    }
                }
            }

        </script>

        <div class="ui modal">
            <div class="header" id="poc_header">
                Upload PoC: 1 of 1
            </div>
            <div class="image content">
                <div class="ui medium image">
                    <img id="poc_img">
                    <pre style="overflow: auto"><code style="max-height: 400px;" id="poc_txt">1234</code></pre>
                </div>
                <div class="description" style="width: calc(100% - 300px)">
                    <div class="ui header">Fill information about Proof-of-Concept</div>
                    <form class="ui form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="ui field">
                            <div class="ui labeled disabled input" style="margin-bottom: 15px">
                                <div class="ui label" style="width: 119px;">
                                    <i class="file alternate outline icon"></i>Filename
                                </div>
                                <input type="text" placeholder="mysite.com" id="poc_filename" readonly>
                            </div>
                        </div>
                        <div class="ui field">
                            <div class="ui labeled input" id="poc_description">
                                <div class="ui label">
                                    <i class="sticky note outline icon"></i>Description
                                </div>
                                <input type="text" name="description" id="poc_description_value"
                                    placeholder="PoC description">
                            </div>
                        </div>
                        <div class="field">
                            <div class="ui fluid selection dropdown" id="poc_service_list">
                                <input type="hidden" name="service" id="poc_service_value" required value="0:0">
                                <i class="dropdown icon"></i>
                                <div class="default text">Select type</div>
                                <div class="menu">
                                    <div class="item" data-value="0:0">No service</div>
                                    {% set targets = json_unpack(current_issue['services']) %}
                                    {% for port_id in targets %}
                                    {% set current_port = db.select_port(port_id)[0] %}
                                    {% for hostname_id in targets[port_id] %}
                                    {% if hostname_id=='0' %}
                                    {% set host = db.select_host_by_port_id(port_id)[0] %}
                                    <div class="item" data-value="{{ port_id }}:0">
                                        {{ (host['ip']) }}{% if current_port['port'] != 0 %}:{{ (current_port['port'])
                                        }}{% endif %}</div>
                                    {% else %}
                                    {% set current_hostname=db.select_hostname(hostname_id)[0] %}
                                    <div class="item" data-value="{{ port_id }}:{{ hostname_id }}">
                                        {{ (current_hostname['hostname']) }}
                                        {% if current_port['port'] != 0 %}:{{ (current_port['port']) }}{% endif %}</div>
                                    {% endif %}
                                    {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="ui indicating progress" id="progress_bar"
                style="width: 90%; margin-left: auto; margin-right: auto;">
                <div class="bar">
                    <div class="progress"></div>
                </div>
                <div class="label">Uploading file</div>
            </div>
            <div class="actions">
                <button class="ui black deny button" id="next_file_button">
                    Next file
                </button>
                <button class="ui positive right labeled icon button" id="send_file_button" type="button">
                    Send
                    <i class="angle double right icon"></i>
                </button>
            </div>
        </div>
        <style>
            .ui.dropdown .menu {
                min-width: 100%;
            }

            .ui.dropdown.dropdown .menu>.input {
                min-width: 80%;
            }
        </style>
        <div class="ui grid">
            <div class="ui column" style="width: 75px; padding-top: 50px;">
                {% include 'project/sidebar.html' %}
            </div>
            <div class="ui column" style="width: calc(100% - 75px)">
                <h1 class="ui header" style="width: calc(100% - 220px); float:left; overflow-wrap: anywhere">Issue: {{
                    (current_issue['name']) }}</h1>
                <div class="ui floating dropdown labeled icon button green" style="float:right" id="template_dropdown">
                    <i class="plus icon"></i>
                    <span class="text">Use template</span>
                    <div class="menu">
                        <div class="ui icon search input">
                            <i class="search icon"></i>
                            <input type="text" placeholder="Search template...">
                        </div>
                        <div class="divider"></div>
                        <div class="header">
                            <i class="tags icon"></i>
                            Issue templates
                        </div>
                        <div class="scrolling menu">
                            <a target="_blank" rel="noopener noreferrer" class="item" href="/profile#/config"
                                style="width: 285px; white-space:normal; word-break: break-all">
                                <div></div>
                                <i class="yellow star outline icon"></i>Create a new template
                            </a>
                            {% set issue_templates = db.select_user_issue_templates(current_user['id']) %}
                            {% for current_template in issue_templates %}
                            {% if current_template['cvss'] == 0 %}
                            {% set template_color = 'blue' %}
                            {% elif current_template['cvss'] <=3.9 %} {% set template_color='green' %} {% elif
                                current_template['cvss'] <=6.9 %} {% set template_color='yellow' %} {% elif
                                current_template['cvss'] <=8.9 %} {% set template_color='orange' %} {% else %} {% set
                                template_color='red' %} {% endif %} <a target="_blank" rel="noopener noreferrer"
                                class="item"
                                href="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/template/{{ current_template['id'] }}/"
                                style="width: 100%; white-space:normal; word-break: break-all">
                                <div class="ui {{ template_color }} empty circular label"></div>
                                {{ (current_template['tpl_name']) }} ({% if current_template['user_id'] %}Personal{%
                                else %}Team: {{ db.select_team_by_id(current_template['team_id'])[0]['name'] }}{% endif
                                %})</a>
                                {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="ui top attached tabular menu" style="margin-bottom: 10px">
                    <a class="item active" data-tab="info">
                        Issue information
                    </a>
                    <a class="item" data-tab="poc">
                        Proof of concepts
                    </a>
                    <a class="item" data-tab="fields">
                        Additional fields
                    </a>
                    <!--<a class="item" data-tab="scores">
                        Issue metrics
                    </a>-->
                </div>
                <div class="ui tab active" data-tab="info">
                    <form class="ui form" method="post" id="edit_issue_form" onsubmit="canva_to_b64('edit_issue_form')"
                        action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/"
                        style="margin-top: 15px; width: 100%">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="ui grid" style="width: 100%">
                            <div class="eight wide column">
                                <div class="ui container" style="width: 90%; float: left;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 130px;">
                                                <i class="at icon"></i>Name:
                                            </div>
                                            <input type="text" name="name" placeholder="SQL injection.." required
                                                value="{{ (current_issue['name']) }}">
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 130px;">
                                                <i class="sticky note outline icon"></i>Description:
                                            </div>
                                            <textarea rows="8" name="description"
                                                placeholder="Vulnerability description">{{ (current_issue['description']) }}</textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 130px;">
                                                <i class="medkit icon"></i>Fix:
                                            </div>
                                            <textarea rows="2" name="fix"
                                                placeholder="To fix this vulnerability you need...">{{ (current_issue['fix']) }}</textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="cog icon"></i>Technical:
                                            </div>
                                            <textarea rows="2" name="technical"
                                                placeholder="Technical information about issue">{{ (current_issue['technical']) }}</textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="exclamation triangle icon"></i>Risks:
                                            </div>
                                            <textarea rows="2" name="risks"
                                                placeholder="Issue exploitation risks">{{ (current_issue['risks']) }}</textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="linkify icon"></i>References:
                                            </div>
                                            <textarea rows="2" name="references"
                                                placeholder="Some links with issue information">{{ (current_issue['references']) }}</textarea>
                                        </div>
                                    </div>
                                    </br>Double click to copy
                                    <div class="ui grid" style="height: 400px; margin-top:-30px;">
                                        <div class="eight wide column">
                                            <div class="ui field">
                                                <div class="ui dropdown" id="hosts_list" style="width: 100%;">
                                                    <div class="menu transition visible" style="width: 90%;">
                                                        <div class="ui icon search input">
                                                            <i class="search icon"></i>
                                                            <input type="text" name="Search"
                                                                placeholder="Search&hellip;" id="input_search_ip">
                                                        </div>
                                                        <div class="scrolling menu" style="height:270px;"
                                                            id="host-port-list">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="eight wide column">
                                            <div class="ui field">
                                                <div class="ui dropdown" id="hostnames_list" style="width: 100%;">
                                                    <div class="menu transition visible" style="width: 90%;">
                                                        <div class="ui icon search input">
                                                            <i class="search icon"></i>
                                                            <input type="text" name="Search"
                                                                placeholder="Search&hellip;" id="input_search_hostname">
                                                        </div>
                                                        <div class="scrolling menu" style="height:270px;"
                                                            id="hostname-port-list">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="folder open icon"></i>URL path/service:
                                        </div>
                                        <input type="text" name="url" placeholder="/admin/"
                                            value="{{ (current_issue['url_path']) }}">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input" style="margin: 0 0 1em;">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CVSS:
                                        </div>
                                        <input type="text" id="origin_cvss" name="cvss" step="0.01" min="0" max="10" readonly="readonly"
                                            placeholder="10.0" value="{{ (current_issue['cvss']) }}" style="width: 100px;">
                                    </div>
                                    <div class="ui labeled input" style="margin: 0 0 1em;">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>Vector:
                                        </div>
                                        <input id="origin_cvss_vector" style="min-width: 350px;" type="text" name="cvss_vector" readonly="readonly"
                                            placeholder="CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N"
                                            value="{% if 'cvss_vector' in current_issue %}{{ current_issue['cvss_vector'] }}{% endif %}">
                                        
                                    </div>
                                    <div style="text-align: center;">
                                        <button type="button" class="ui button blue"
                                                onclick="$('#cvss_hidden').toggle();">
                                                <i class="ui calculator icon"></i>CVSS calculator
                                        </button>
                                    </div>
                                </div>
                                <div id="cvss_hidden" style="display: none">
                                    <div class="ui divider"></div>
                                    <div id="cvssboard">
                                    </div>
                                    <div id="chartjs-radar">
                                        <canvas id="canvas"></canvas>
                                    </div>
                                    <div class="ui divider"></div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CVE:
                                        </div>
                                        <input type="text" name="cve" placeholder="2020-1337"
                                            value="{{ (current_issue['cve']) }}">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CWE:
                                        </div>
                                        <input type="number" name="cwe" placeholder="123"
                                            value="{{ (current_issue['cwe']) }}">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="question circle icon"></i>Status:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="status" required
                                                value="{{ (current_issue['status']) }}">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select status</div>
                                            <div class="menu">
                                                <div class="item" data-value="PoC creation">PoC creation</div>
                                                <div class="item" data-value="PoC available">PoC available</div>
                                                <div class="item" data-value="Confirmed">Confirmed</div>
                                                <div class="item" data-value="Wasn't Confirmed">Wasn't Confirmed</div>
                                                <div class="item" data-value="Pending...">Pending...</div>
                                                <div class="item" data-value="Need to check">Need to check</div>
                                                <div class="item" data-value="Need to recheck">Need to recheck</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="exclamation triangle icon"></i>Criticality:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="criticality" required value="-1">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select criticality</div>
                                            <div class="menu">
                                                <div class="item" data-value="-1">use CVSS criticality</div>
                                                <div class="item" data-value="0"><i
                                                        class="warning circle blue icon"></i>Information
                                                    (cvss=0.0)
                                                </div>
                                                <div class="item" data-value="2"><i
                                                        class="warning circle green icon"></i>Low
                                                    (cvss=2.0)
                                                </div>
                                                <div class="item" data-value="5"><i
                                                        class="warning circle yellow icon"></i>Medium
                                                    (cvss=5.0)
                                                </div>
                                                <div class="item" data-value="8"><i
                                                        class="warning circle orange icon"></i>High
                                                    (cvss=8.0)
                                                </div>
                                                <div class="item" data-value="9.5"><i
                                                        class="warning circle red icon"></i>Critical
                                                    (cvss=9.5)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="desktop icon"></i>Parameter:
                                        </div>
                                        <input type="text" name="param" placeholder="(GET) id=123"
                                            value="{{ (current_issue['param']) }}">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="desktop icon"></i>Type:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="issue_type" required
                                                value="{{ (current_issue['type']) }}">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select type</div>
                                            <div class="menu">
                                                <div class="item" data-value="custom">Custom</div>
                                                <div class="item" data-value="web">Web</div>
                                                <div class="item" data-value="credentials">Credentials</div>
                                                <div class="item" data-value="service">Service</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="user secret icon"></i>Intruder:
                                        </div>
                                        <input type="text" name="intruder"
                                            placeholder="Noire / Grise / Blanche"
                                            value="{{ current_issue['intruder'] }}">
                                    </div>
                                </div>
                                {% if update_info_errors is defined and update_info_errors %}
                                <div class="ui error message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        There were some errors with issue
                                    </div>
                                    <ul class="list">
                                        {% for error in update_info_errors %}
                                        <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                {% if errors is defined and not errors %}
                                <div class="ui success message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        Issue was added successfully!
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" style="float: left;" class="ui button blue"><i
                                class="plus icon"></i>Update
                        </button>
                    </form>
                    <form action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/delete_issue"
                        method="post" onsubmit="return delete_prompt(this,'Are you sure to delete issue?')"
                        style="display: inline-block;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="ui button red"><i class="trash icon"></i>Delete</button>
                        <a href="/share/issue/{{ current_issue['id'] }}/" class="ui button purple"><i
                                class="share square icon"></i>Share</a>
                    </form>
                    <form action="/new_template_from_issue" method="post" target="_blank"
                        style="display: inline-block;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <input type="hidden" name="issue_id" value="{{ current_issue['id'] }}" />
                        <button type="submit" class="ui button orange" style="align: left;">
                            <i class="copy icon"></i>New template
                        </button>
                    </form>
                    <a href="/project/{{ current_project['id'] }}/tools/exporter/?issue_name={{ current_issue['id'] }}"
                        target="_blank" rel="noopener noreferrer" class="ui button green" style="align: left;">
                        <i class="ui icon share"></i>Export hosts
                    </a>
                </div>
                <script>

                    $(document).ready(function () {
                        var table = $('#poc_list').DataTable({
                            "iDisplayLength": -1,
                            aLengthMenu: [
                                [10, 25, 50, 100, 200, -1],
                                [10, 25, 50, 100, 200, "All"]
                            ],
                            'columnDefs': [{
                                'targets': 4,
                                'searchable': false,
                                'orderable': false,
                            }],
                            "columns": [
                                null,
                                null,
                                null,
                                {
                                    "orderable": false,
                                    "className": "dt-body-center"
                                },
                                null
                            ]
                        });
                    });

                    function set_priority(element) {
                        priority = 1;
                        if (!element.classList.contains("outline")) {
                            priority = 0;
                        }
                        /*
                        images = document.querySelectorAll('[id=flag_img]');
                        for (i = 0; i < images.length; i++) {
                            images[i].classList.add("outline");
                        }*/
                        poc_id = element.attributes["data-value"].value;
                        csrf = '{{ csrf_token() }}';
                        data = 'poc_id=' + poc_id + '&csrf_token=' + csrf + '&priority=' + priority;
                        $.ajax({
                            type: "POST",
                            url: '/project/{{current_project['id']}}/issue/{{current_issue['id']}}/set_priority',
                            data: data,
                        }).done(function (response) {
                            if (response === "ok") {
                                if (priority) {
                                    element.classList.remove("outline");
                                } else {
                                    element.classList.add("outline");
                                }
                            }
                        });

                    };

                </script>

                <style>
                    tr.odd {
                        background-color: #fffdc2;
                    }

                    tr.even {
                        background-color: #c3ffcd;
                    }

                    .ui.menu:last-child {
                        margin-bottom: 0px;
                    }
                </style>
                <div class="ui tab" data-tab="poc">
                    <table id="poc_list" class="ui table" style="width: 100%">
                        <thead>
                            <tr id="table_header">
                                <th style="width: 50px;"></th>
                                <th>
                                    <h4>host</h4>
                                </th>
                                <th>
                                    <h4>description</h4>
                                </th>
                                <th>
                                    <h4>proof-of-concept</h4>
                                </th>
                                <th style="width: 135px;">
                                    <h4>action</h4>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set pocs = db.select_issue_pocs(current_issue['id']) %}
                            {% for current_poc in pocs %}
                            <tr>
                                <td>
                                    <i data-value="{{ current_poc['id'] }}"
                                        class="flag red {% if not current_poc['priority'] %}outline{% endif %} big icon"
                                        id="flag_img" style="cursor: pointer;" onclick="set_priority(this)"></i>
                                </td>
                                {% if not (current_poc['hostname_id']=='0' and current_poc['port_id']=='0') %}
                                {% if current_poc['hostname_id']=='0' %}
                                {% set host = db.select_host_by_port_id(current_poc['port_id'])[0]['ip'] %}
                                {% else %}
                                {% set host = db.select_hostname(current_poc['hostname_id'])[0]['hostname'] %}
                                {% endif %}
                                {% set current_port = db.select_port(current_poc['port_id'])[0] %}
                                {% endif %}
                                <td style="word-break: break-all;text-align: left;">
                                    {% if not (current_poc['hostname_id']=='0' and current_poc['port_id']=='0') %}
                                    <h4>{{ (host) }}{% if current_port['port'] != 0 %}:
                                        {{ (current_port['port']) }}{% endif %}</h4>
                                    {% endif %}
                                </td>
                                <td>{{ (current_poc['description']) }}</td>
                                <td style="align-content: center;">
                                    {% if current_poc['type']=='image' %}
                                    <div class="ui grid">
                                        <div class="ui sixteen column centered grid">
                                            <img src="/static/files/poc/{{ current_poc['id'] }}"
                                                style="max-height: 400px;max-width: 800px">
                                        </div>
                                    </div>
                                    {% else %}{% autoescape false %}
                                    <pre
                                        style="overflow: auto"><code
                                    style="max-height: 400px; max-width:800px; margin-left: 10px; margin-right: 10px;">{{ escape(open('static/files/poc/'+current_poc['id']).read().replace('\r','')) }}</code></pre>
                                    {% endautoescape %}{% endif %}
                                </td>
                                <td>
                                    <a href="/static/files/poc/{{ current_poc['id'] }}"
                                        class="ui vertical animated button blue" tabindex="0">
                                        <div class="hidden content">Download</div>
                                        <div class="visible content">
                                            <i class="download icon"></i>
                                        </div>
                                    </a>
                                    <form style="float:left;"
                                        action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/delete_poc"
                                        method="post"
                                        onsubmit="return delete_prompt(this,'Are you sure to delete PoC?')">
                                        <button type="submit" class="ui vertical animated button red" tabindex="0"
                                            name="poc_id" value="{{ current_poc['id'] }}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                            <div class="hidden content">Delete</div>
                                            <div class="visible content">
                                                <i class="trash icon"></i>
                                            </div>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <h2 class="ui dividing header">Upload PoC (or CTRL+V):</h2>
                    <form class="ui form" method="post"
                        action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/new_poc#poc"
                        enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="ui field">
                            <div class="four fields">
                                <div class="field">
                                    <div class="ui fluid selection dropdown" id="services_list">
                                        <input type="hidden" name="service" required value="0:0">
                                        <i class="dropdown icon"></i>
                                        <div class="default text">Select type</div>
                                        <div class="menu">
                                            <div class="item" data-value="0:0">No service</div>
                                            {% set targets = json_unpack(current_issue['services']) %}
                                            {% for port_id in targets %}
                                            {% set current_port = db.select_port(port_id)[0] %}
                                            {% for hostname_id in targets[port_id] %}
                                            {% if hostname_id=='0' %}
                                            {% set host = db.select_host_by_port_id(port_id)[0] %}
                                            <div class="item" data-value="{{ port_id }}:0">
                                                {{ (host['ip']) }}{% if current_port['port'] != 0 %}:
                                                {{ (current_port['port']) }}{% endif %}</div>
                                            {% else %}
                                            {% set current_hostname=db.select_hostname(hostname_id)[0] %}
                                            <div class="item" data-value="{{ port_id }}:{{ hostname_id }}">
                                                {{ (current_hostname['hostname']) }}
                                                {% if current_port['port'] != 0 %}:
                                                {{ (current_port['port']) }}{% endif %}</div>
                                            {% endif %}
                                            {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <input type="text" name="comment" placeholder="PoC description">
                                </div>
                                <div class="field">
                                    <label for="file" class="ui icon button" style="margin-bottom: 15px;">
                                        <div><i class="file icon"></i>
                                            <div id="file_button" style="display: initial;"> Open File</div>
                                        </div>
                                    </label>
                                    <input type="file" id="file" name="file" onchange="filename_change(this);" required
                                        style="display:none">
                                </div>
                                <div class="field">
                                    <button type="submit" class="ui button blue"><i
                                            class="upload icon"></i>Upload</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% if poc_errors is defined and poc_errors %}
                    <div class="ui error message visible">
                        <i class="close icon"></i>
                        <div class="header">
                            There were some errors with PoC
                        </div>
                        <ul class="list">
                            {% for error in poc_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <div class="ui tab" data-tab="fields">
                    {% set fields = json_unpack(current_issue['fields']) %}
                    <script>
                        $(document).ready(function () {
                            $('#new_field_dropdown').dropdown({});
                        });
                        var fields_list = {{ json_pack(list(fields)) | safe }};

                        function add_field() {
                            html = `<div>
                                          <h4>__field_name__ (__field_type__)</h4>
                                          <input type="hidden" name="additional_field_name" value="__field_name__">
                                          <input type="hidden" name="additional_field_type" value="__field_db_type__">
                                                <div class="ui two fields">
                                                    <div class="field">
                                                        <div class="ui input">
                                                            <input type="__field_html_type__" placeholder="Field value" name="additional_field_value">
                                                        </div>
                                                    </div>
                                                    <div class="field">
                                                        <button class="ui button red" type="button" onclick="delete_field(this,'__field_name__');">
                                                            <i class="trash icon"></i>Delete variable
                                                        </button>
                                                    </div>
                                                </div>
                                </div>`;
                            name_obj = $('#field_name')[0];
                            field_name = name_obj.value.toString();
                            field_db_type = $('#field_type')[0].value.toString();
                            field_html_type = 'text'
                            switch (field_db_type) {
                                case 'text':
                                    field_html_type = 'text';
                                    field_type = 'Text';
                                    break;
                                case 'number':
                                    field_html_type = 'number';
                                    field_type = 'Number';
                                    break;
                                case 'float':
                                    field_html_type = 'number';
                                    field_type = 'Float';
                                    break;
                                case 'boolean':
                                    field_html_type = 'number';
                                    field_type = 'Boolean 0..1';
                                    break;
                                default:
                                    field_db_type = 'text';
                                    field_type = 'Text';
                                    break;
                            }


                            var re = new RegExp("^[a-zA-Z0-9_]+$");

                            if (field_name !== '' && re.test(field_name) && !fields_list.includes(field_name)) {
                                tmp_html = html.replaceAll('__field_name__', field_name)
                                    .replaceAll('__field_type__', field_type)
                                    .replaceAll('__field_html_type__', field_html_type)
                                    .replaceAll('__field_db_type__', field_db_type);
                                fields_list.push(field_name);
                                $('#fields_list').append(tmp_html);
                                name_obj.value = '';
                            } else if (fields_list.includes(field_name)) {
                                $('body')
                                    .toast({
                                        class: 'error',
                                        position: 'bottom left',
                                        message: 'Additional field "' + field_name + '" already exists!'
                                    });
                            } else {
                                $('body')
                                    .toast({
                                        class: 'error',
                                        position: 'bottom left',
                                        message: 'Wrong field name! Regexp:[a-zA-Z0-9_]+'
                                    });
                            }


                        }

                        function add_file_field() {
                            html = `<div>
                                    <h4>File: __field_name__</h4>
                                    <input type="hidden" name="additional_field_name" value="__field_name__">
                                    <div class="ui two fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="file" required name="additional_field_file">
                                            </div>
                                        </div>
                                        <div class="field">
                                            <button class="ui button red" type="button" onclick="delete_field(this,'__field_name__');">
                                                <i class="trash icon"></i>Delete variable
                                            </button>
                                        </div>
                                    </div>
                                </div>`;
                            name_obj = $('#file_name')[0];
                            field_name = name_obj.value.toString();


                            var re = new RegExp("^[a-zA-Z0-9_]+$");

                            if (field_name !== '' && re.test(field_name) && !fields_list.includes(field_name)) {
                                tmp_html = html.replaceAll('__field_name__', field_name)
                                fields_list.push(field_name);
                                $('#files_list').append(tmp_html);
                                name_obj.value = '';
                            } else if (fields_list.includes(field_name)) {
                                $('body')
                                    .toast({
                                        class: 'error',
                                        position: 'bottom left',
                                        message: 'Additional field "' + field_name + '" already exists!'
                                    });
                            } else {
                                $('body')
                                    .toast({
                                        class: 'error',
                                        position: 'bottom left',
                                        message: 'Wrong field name! Regexp:[a-zA-Z0-9_]+'
                                    });
                            }

                        }

                        function delete_field(button_obj, field_name) {
                            elem = button_obj.parentElement.parentElement.parentElement;
                            elem.parentNode.removeChild(elem);

                            for (var i = 0; i < fields_list.length; i++) {
                                if (fields_list[i] === field_name) {
                                    fields_list.splice(i, 1);
                                }
                            }
                        };

                        function filename_change(obj) {
                            button_obj = $('#file_button')[0];
                            if (obj.files.length === 1) {
                                button_obj.innerText = " " + obj.files[0].name;
                            } else if (obj.files.length > 1) {
                                button_obj.innerText = " selected " + obj.files.length + " files";
                            } else {
                                button_obj.innerText = " Open file";
                            }
                        }

                    </script>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="ui grid">
                        <div class="two column row">

                            <div class="ui column">
                                <h2 class="ui dividing header">Text fields</h2>
                                <form
                                    action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/edit_text_fields"
                                    method="post" class="ui form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <div id="fields_list">
                                        {% for field_name in fields %}
                                        {% if fields[field_name]['type'] != 'file' %}
                                        <div>
                                            <h4>{{ (field_name) }} ({{ fields[field_name]['type'] }})</h4>
                                            <input type="hidden" name="additional_field_name"
                                                value="{{ (field_name) }}">
                                            <input type="hidden" name="additional_field_type"
                                                value="{{ fields[field_name]['type'] }}">
                                            <div class="ui two fields">
                                                <div class="field">
                                                    <div class="ui input">
                                                        {% if fields[field_name]['type'] == 'text' %}
                                                        <input type="text" value="{{ (fields[field_name]['value']) }}"
                                                            placeholder="Field value" name="additional_field_value">
                                                        {% elif fields[field_name]['type'] == 'float' %}
                                                        <input type="number" step="any"
                                                            value="{{ fields[field_name]['value'] | float }}"
                                                            placeholder="Field value" name="additional_field_value">
                                                        {% else %}
                                                        <input type="number"
                                                            value="{{ fields[field_name]['value'] | int }}"
                                                            placeholder="Field value" name="additional_field_value">
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="field">
                                                    <button class="ui button red" type="button"
                                                        onclick="delete_field(this,'{{ (field_name) }}');">
                                                        <i class="trash icon"></i>Delete variable
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>

                                    <div class="divider"></div>
                                    <h3 class="ui dividing header">Add field</h3>
                                    <div class="ui three fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="text" id="field_name"
                                                    placeholder="field_name [a-zA-Z0-9_]"> </input>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <div class="ui fluid selection dropdown" id="new_field_dropdown">
                                                <input type="hidden" id="field_type" value="text" required>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select field type</div>
                                                <div class="menu">
                                                    <div class="item" data-value="text">Text field</div>
                                                    <div class="item" data-value="number">Number field</div>
                                                    <div class="item" data-value="float">Float field</div>
                                                    <div class="item" data-value="boolean">Boolean field</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <div class="two fields">
                                                <div class="field">
                                                    <button class="ui button blue" type="button" onclick="add_field();">
                                                        <i class="icon plus"></i>Add
                                                    </button>
                                                </div>
                                                <div class="field">
                                                    <button type="submit" class="ui violet button">
                                                        <i class="save icon"></i>Save
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="ui column">
                                <h2 class="ui dividing header">File fields</h2>
                                <form
                                    action="/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/edit_file_fields"
                                    method="post" enctype="multipart/form-data" class="ui form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <div id="files_list">
                                        {% for field_name in fields %}
                                        {% if fields[field_name]['type'] == 'file' %}
                                        <div>
                                            <h4>File: {{ (field_name) }}</h4>
                                            <input type="hidden" name="additional_field_old_file"
                                                value="{{ (field_name) }}">
                                            <div class="ui two fields">
                                                <div class="field">
                                                    <div class="ui input">
                                                        <input type="text"
                                                            value="{{ (db.select_files(fields[field_name]['value'])[0]['filename']) }}"
                                                            readonly>
                                                    </div>
                                                </div>
                                                <div class="field">
                                                    <a class="ui button blue" type="button"
                                                        href="/static/files/fields/{{ fields[field_name]['value'] }}">
                                                        <i class="download icon"></i>Download
                                                    </a>
                                                    <button class="ui button red" type="button"
                                                        onclick="delete_field(this,'{{ (field_name) }}');">
                                                        <i class="trash icon"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    <h3 class="ui dividing header">Add field</h3>
                                    <div class="ui two fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="text" placeholder="field_name1 [a-zA-Z0-9_]"
                                                    id="file_name"> </input>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <div class="two fields">
                                                <div class="field">
                                                    <button class="ui button blue" type="button"
                                                        onclick="add_file_field();">
                                                        <i class="icon plus"></i>Add
                                                    </button>
                                                </div>
                                                <div class="field">
                                                    <button type="submit" class="ui violet button">
                                                        <i class="save icon"></i>Save
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="ui tab" data-tab="scores">
                    <div class="ui top attached tabular menu" style="margin-bottom: 10px">
                        <a class="item active" data-tab="cvss">
                            CVSS
                        </a>
                        <a class="item" data-tab="owasp">
                            OWASP Risk Rating
                        </a>
                    </div>

                    <script>


                    </script>

                    <div class="ui tab active" data-tab="cvss">
                        <div class="ui labeled input">
                            <div class="ui label" style="width: 125px;">
                                <i class="hashtag icon"></i>CVSS:
                            </div>
                            <input type="number" id="cvss_tab_num" name="cvss" step="0.01" min="0" max="10"
                                placeholder="10.0" value="{{ (current_issue['cvss']) }}">
                        </div>
                        <div class="ui labeled input">
                            <div class="ui label" style="width: 125px;">
                                <i class="hashtag icon"></i>Vector:
                            </div>
                            <input id="cvss_tab_vector" style="min-width: 350px;" type="text" name="cvss_vector"
                                placeholder="CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N"
                                value="{% if 'cvss_vector' in issue_fields %}{{ issue_fields['cvss_vector']['value'] }}{% endif %}">
                        </div>
                        <button type="button" onclick="update_cvss();" class="ui blue button"><i
                                class="icon save"></i>Save</button>
                        <div class="ui divider"></div>
                        <div id="cvssboard_metrics">
                        </div>
                        <div id="chartjs-radar">
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                    <script>
                        function copy_owasp(copy_type) {
                            owasp_vector = $('#score')[0].innerText;
                            owasp_vector = owasp_vector.replace("(", "").replace(")", "");

                            if (owasp_vector !== '') {
                                $('#owasp_vector')[0].value = owasp_vector;
                            }
                        }

                        function update_owasp() {

                            owasp_vector = $('#owasp_vector')[0].value;

                            csrf = "{{ csrf_token() }}";

                            // send owasp vector
                            $.ajax({
                                type: "POST",
                                url: '/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/edit_field',
                                data: {
                                    'csrf_token': csrf,
                                    'additional_field_name': 'owasp_vector',
                                    'additional_field_type': 'text',
                                    'additional_field_value': owasp_vector
                                },
                                success: function (data) {
                                    if (data === 'ok') {
                                        // change cvss at main page
                                        $('body')
                                            .toast({
                                                class: 'success',
                                                position: 'bottom right',
                                                message: `Saved!`
                                            });
                                    } else {
                                        $('body')
                                            .toast({
                                                class: 'error',
                                                position: 'bottom right',
                                                message: `Error!`
                                            });
                                    }
                                },
                                error: function (data) {
                                    $('body')
                                        .toast({
                                            class: 'error',
                                            position: 'bottom right',
                                            message: `Error!`
                                        });
                                }
                            });
                        }
                    </script>
                    <div class="ui tab" data-tab="owasp">

                        <main>
                            <section>
                                <div class="ui labeled input">
                                    <div class="ui label" style="width: 125px;">
                                        <i class="hashtag icon"></i>Vector:
                                    </div>
                                    <input id="owasp_vector" style="min-width: 590px;" type="text" name="owasp_vector"
                                        placeholder="SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:2/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3"
                                        value="{% if 'owasp_vector' in issue_fields %}{{ issue_fields['owasp_vector']['value'] }}{% endif %}">
                                </div>
                                <button type="button" onclick="update_owasp();" class="ui blue button"><i
                                        class="icon save"></i>Save</button>
                                <div>
                                    <b>VECTOR: </b><a id="score" target="_blank">({% if 'owasp_vector' in issue_fields
                                        %}{{ issue_fields['owasp_vector']['value'] }}{% endif %})</a>
                                    <button type="button" class="ui orange button" onclick="copy_owasp();"><i
                                            class="icon copy"></i>Copy vector</button>
                                    <br>
                                </div>
                            </section>
                            <section>
                                <canvas class="riskChart" id="riskChart" height="75"></canvas>
                                <div class="risk RS">
                                    <h4>0</h4>
                                </div>
                            </section>
                             FIRST 
                            <div class="row">
                             THREAT AGENT FACTORS 
                                <section>
                                    <h5 class="border-bottom"
                                        title="The first set of factors are related to the threat agent involved. The goal here is to estimate the likelihood of a successful attack by this group of threat agents. Use the worst-case threat agent.">
                                        Threat Agent Factors</h5>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How technically skilled is this group of threat agents?">Skill level
                                        </div>
                                        <div class="col-8">
                                            <select class="form-control" id="sl" name="sl" onchange="calculate()">
                                                <option value="1">No technical skills (1)</option>
                                                <option value="3">Some technical skills (3)</option>
                                                <option value="5">Advanced computer user (5)</option>
                                                <option value="6">Network and programming skills (6)</option>
                                                <option value="9">Security penetration skills (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How motivated is this group of threat agents to find and exploit this vulnerability?">
                                            Motive</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="m"
                                                name="m" onchange="calculate()">
                                                <option value="1">Low or no reward (1)</option>
                                                <option value="4">Possible reward (4)</option>
                                                <option value="9">High reward (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="What resources and opportunities are required for this group of threat agents to find and exploit this vulnerability?">
                                            Opportunity</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="o"
                                                name="o" onchange="calculate()">
                                                <option value="0">Full access or expensive resources required (0)
                                                </option>
                                                <option value="4">Special access or resources required (4)</option>
                                                <option value="7">Some access or resources required (7)</option>
                                                <option value="9">No access or resources required (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How large is this group of threat agents?">Size</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="s"
                                                name="s" onchange="calculate()">
                                                <option value="2">Developers, System administrators (2)</option>
                                                <option value="4">Intranet users (4)</option>
                                                <option value="5">Partners (5)</option>
                                                <option value="6">Authenticated users (6)</option>
                                                <option value="9">Anonymous Internet users (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>

                                TECHNICAL IMPACT FACTORS
                                <section>
                                    <h5 class="border-bottom"
                                        title="Technical impact can be broken down into factors aligned with the traditional security areas of concern: confidentiality, integrity, availability, and accountability. The goal is to estimate the magnitude of the impact on the system if the vulnerability were to be exploited. ">
                                        Technical Impact Factors</h5>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much data could be disclosed and how sensitive is it?">Loss of
                                            confidentiality</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="lc"
                                                name="lc" onchange="calculate()">
                                                <option value="2">Minimal non-sensitive data disclosed (2)</option>
                                                <option value="6">minimal critical data disclosed (6)</option>
                                                <option value="6">extensive non-sensitive data disclosed (6)</option>
                                                <option value="7">extensive critical data disclosed (7)</option>
                                                <option value="9">all data disclosed (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much data could be corrupted and how damaged is it?">Loss of
                                            integrity</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="li"
                                                name="li" onchange="calculate()">
                                                <option value="1">Minimal slightly corrupt data (1)</option>
                                                <option value="3">Minimal seriously corrupt data (3)</option>
                                                <option value="5">Extensive slightly corrupt data (5)</option>
                                                <option value="7">Extensive seriously corrupt data (7)</option>
                                                <option value="9">All data totally corrupt (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much service could be lost and how vital is it?">Loss of
                                            availability</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="lav"
                                                name="lav" onchange="calculate()">
                                                <option value="1">Minimal secondary services interrupted (1)</option>
                                                <option value="5">Minimal primary services interrupted (5)</option>
                                                <option value="5">Extensive secondary services interrupted (5)</option>
                                                <option value="7">Extensive primary services interrupted (7)</option>
                                                <option value="9">All services completely lost (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="Are the threat agents' actions traceable to an individual?">Loss of
                                            accountability</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="lac"
                                                name="lac" onchange="calculate()">
                                                <option value="1">Fully traceable (1)</option>
                                                <option value="7">Possibly traceable (7)</option>
                                                <option value="9">Completely anonymous (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            SECOND
                            <div class="row">
                                VULNERABILITY FACTORS
                                <section>
                                    <h5 class="border-bottom"
                                        title="The next set of factors are related to the vulnerability involved. The goal here is to estimate the likelihood of the particular vulnerability involved being discovered and exploited. Assume the threat agent selected above.">
                                        Vulnerability Factors</h5>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How easy is it for this group of threat agents to discover this vulnerability?">
                                            Ease of discovery</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="ed"
                                                name="ed" onchange="calculate()">
                                                <option value="1">Practically impossible (1)</option>
                                                <option value="3">Difficult (3)</option>
                                                <option value="7">Easy (7)</option>
                                                <option value="9">Automated tools available (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How easy is it for this group of threat agents to actually exploit this vulnerability?">
                                            Ease of exploit</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="ee"
                                                name="ee" onchange="calculate()">
                                                <option value="1">Theoretical (1)</option>
                                                <option value="3">Difficult (3)</option>
                                                <option value="5">Easy (5)</option>
                                                <option value="9">Automated tools available (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How well known is this vulnerability to this group of threat agents?">
                                            Awareness</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="a"
                                                name="a" onchange="calculate()">
                                                <option value="1">Unknown (1)</option>
                                                <option value="4">Hidden (4)</option>
                                                <option value="6">Obvious (6)</option>
                                                <option value="9">Public knowledge (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How likely is an exploit to be detected?">Intrusion detection</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="id"
                                                name="id" onchange="calculate()">
                                                <option value="1">Active detection in application (1)</option>
                                                <option value="3">Logged and reviewed (3)</option>
                                                <option value="8">Logged without review (8)</option>
                                                <option value="9">Not logged (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>

                                BUSINESS IMPACT FACTORS
                                <section>
                                    <h5 class="border-bottom"
                                        title="The business impact stems from the technical impact, but requires a deep understanding of what is important to the company running the application. In general, you should be aiming to support your risks with business impact, particularly if your audience is executive level. The business risk is what justifies investment in fixing security problems.">
                                        Business Impact Factors</h5>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much financial damage will result from an exploit?">Financial
                                            damage</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="fd"
                                                name="fd" onchange="calculate()">
                                                <option value="1">Less than the cost to fix the vulnerability (1)
                                                </option>
                                                <option value="3">Minor effect on annual profit (3)</option>
                                                <option value="7">Significant effect on annual profit (7)</option>
                                                <option value="9">Bankruptcy (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="Would an exploit result in reputation damage that would harm the business?">
                                            Reputation damage</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="rd"
                                                name="rd" onchange="calculate()">
                                                <option value="1">Minimal damage (1)</option>
                                                <option value="4">Loss of major accounts (4)</option>
                                                <option value="5">Loss of goodwill (5)</option>
                                                <option value="9">Brand damage (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much exposure does non-compliance introduce?">Non-compliance
                                        </div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="nc"
                                                name="nc" onchange="calculate()">
                                                <option value="2">Minor violation (2)</option>
                                                <option value="5">Clear violation (5)</option>
                                                <option value="7">High profile violation (7)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="h6 nomargin col-4 d-flex align-items-center"
                                            title="How much personally identifiable information could be disclosed?">
                                            Privacy violation</div>
                                        <div class="col-8">
                                            <select class="form-control" aria-label=".form-select-sm example" id="pv"
                                                name="pv" onchange="calculate()">
                                                <option value="3">One individual (3)</option>
                                                <option value="5">Hundreds of people (5)</option>
                                                <option value="7">Thousands of people (7)</option>
                                                <option value="9">Millions of people (9)</option>
                                            </select>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            THIRD
                            <div class="row">
                                LIKELIHOOD SCORE
                                <section>
                                    <h5 class="border-bottom">Likelihood score</h5>
                                    <h6 class="LS nomargin">0</h6>
                                </section>

                                IMPACT SCORE
                                <section>
                                    <h5 class="border-bottom">Impact score</h5>
                                    <h6 class="IS nomargin">0</h6>
                                </section>
                            </div>

                            CREDITS
                            <section>
                                <div>
                                    2021 OWASP Risk Assessment Calculator | Developed by <a
                                        href="https://hackpuntes.com" target="_blank"><span>Javier Olmedo</span></a> |
                                    Source Code on <a href="https://github.com/JavierOlmedo/OWASP-Calculator"
                                        target="_blank"><span>Github</span></a> repository.
                                </div>
                            </section>
                        </main>

                        MODAL
                        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                            aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">How is Severity Risk
                                            caculated?</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            IKELIHOOD AND IMPACT LEVELS
                                            <section>
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col" colspan="2">Likelihood and Impact Levels
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>0 to < 3</td>
                                                            <td class="classNote">LOW</td>
                                                        </tr>
                                                        <tr>
                                                            <td>3 to < 6</td>
                                                            <td class="classMedium">MEDIUM</td>
                                                        </tr>
                                                        <tr>
                                                            <td>6 to 9</td>
                                                            <td class="classHigh">HIGH</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </section>

                                            OVERALL RISK SEVERITY = LIKELIHOOD X IMPACT
                                            <section>
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col" colspan="5">Overall Risk Severity =
                                                                Likelihood x Impact</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="1" rowspan="4"
                                                                style="vertical-align: middle; font-weight: bold">Impact
                                                            </td>
                                                            <td>HIGH</td>
                                                            <td class="classMedium">Medium</td>
                                                            <td class="classHigh">High</td>
                                                            <td class="classCritical">Critical</td>
                                                        </tr>
                                                        <tr>
                                                            <td>MEDIUM</td>
                                                            <td class="classLow">Low</td>
                                                            <td class="classMedium">Medium</td>
                                                            <td class="classHigh">High</td>
                                                        </tr>
                                                        <tr>
                                                            <td>LOW</td>
                                                            <td class="classNote">Note</td>
                                                            <td class="classLow">Low</td>
                                                            <td class="classMedium">Medium</td>
                                                        </tr>
                                                        <tr>
                                                            <td></td>
                                                            <td>LOW</td>
                                                            <td>MEDIUM</td>
                                                            <td>HIGH</td>
                                                        </tr>
                                                    </tbody>
                                                    <thead>
                                                        <tr>
                                                            <th scope="col" colspan="1"></th>
                                                            <th scope="col" colspan="4">Likelihood</th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </section>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK!</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                
                </div>-->
            </div>
            {% include 'footer.html' %}
        </div>
    </div>
<!--
    {% if external_js %}
    <script src="https://javierolmedo.github.io/OWASP-Calculator/js/script.js"></script>
    {% else %}
    <script src="/static/js/owasp_risk.js"></script>
    {% endif %}
    <script>
        owasp_vector = $('#owasp_vector')[0].value;
        if (owasp_vector !== '') {
            loadVectors(owasp_vector);
        }
    </script>
-->
</body>
<script>

    function canva_to_b64(id) {
        var cvss_image = myRadar.toBase64Image();
        var myForm = document.getElementById(id);
        var element = document.createElement("input");
        element.setAttribute("type", "text");
        element.setAttribute("value", cvss_image);
        element.setAttribute("name", "cvss_graph");
        myForm.appendChild(element)
    }

    var c1 = new CVSS("cvssboard", {
        onchange: function () {
            c1.vector.setAttribute('href', '#' + c1.get().vector)
            document.getElementById('origin_cvss').value = c1.get().score;
            document.getElementById('origin_cvss_vector').value = c1.get().vector;
            action()
        }
    });
    cvss_vector = '{% if 'cvss_vector' in current_issue %}{{ current_issue['cvss_vector'] }}{% endif %}';
    if (cvss_vector !== '') {
        c1.set(cvss_vector);
    }
    // add button copy
    cvss_result_obj = document.getElementsByClassName('results')[1];
    cvss_result_obj.insertAdjacentHTML('beforeend', '<button type="button" class="ui orange button" onclick="copy_cvss(\'number\');"> Copy number</button><button type="button" onclick="copy_cvss(\'vector\');" class="ui yellow button">Copy vector</button>');

    function copy_cvss(copy_type) {
        cvss_vector = document.getElementsByClassName('vector')[1].innerText;
        cvss_score = document.getElementsByClassName('score')[1].innerText;

        if (copy_type === "number") {
            if (cvss_score !== '?' && cvss_score !== '') {
                $('#cvss_tab_num')[0].value = parseFloat(cvss_score);
            }
        } else if (copy_type === "vector") {
            $('#cvss_tab_vector')[0].value = cvss_vector;
        }
    }

    function update_cvss() {

        cvss_vector = $('#cvss_tab_vector')[0].value;
        cvss_score = $('#cvss_tab_num')[0].value;

        csrf = "{{ csrf_token() }}";

        if (cvss_score !== '') {
            // send cvss number
            $.ajax({
                type: "POST",
                url: '/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/edit_field',
                data: {
                    'csrf_token': csrf,
                    'additional_field_name': 'origin_cvss',
                    'additional_field_type': 'float',
                    'additional_field_value': parseFloat(cvss_score)
                },
                success: function (data) {
                    if (data === 'ok') {
                        // change cvss at main page
                        $('#origin_cvss')[0].value = parseFloat(cvss_score);
                        $('body')
                            .toast({
                                class: 'success',
                                position: 'bottom right',
                                message: `Saved!`
                            });
                    } else {
                        $('body')
                            .toast({
                                class: 'error',
                                position: 'bottom right',
                                message: `Error!`
                            });
                    }
                },
                error: function (data) {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom right',
                            message: `Error!`
                        });
                }
            });
        }


        // send cvss metrics
        $.ajax({
            type: "POST",
            url: '/project/{{ current_project['id'] }}/issue/{{ current_issue['id'] }}/edit_field',
            data: {
                'csrf_token': csrf,
                'additional_field_name': 'cvss_vector',
                'additional_field_type': 'text',
                'additional_field_value': cvss_vector
            },
            success: function (data) {
                if (data === 'ok') {
                    //idk what to do now :)
                    $('body')
                        .toast({
                            class: 'success',
                            position: 'bottom right',
                            message: `Saved!`
                        });
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom right',
                            message: `Error!`
                        });
                }
            },
            error: function (data) {
                $('body')
                    .toast({
                        class: 'error',
                        position: 'bottom right',
                        message: `Error!`
                    });
            }
        });
    }



    function action() {
        var tmp = c1.get().vector.split("/");
        var score = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        var radar_point = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        for (let index = 1; index < tmp.length; index++) {
            var type = tmp[index].split(":")[0];
            var selection = tmp[index].split(":")[1];
            switch (type) {
                case "AV":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "A":
                            score[type] = 0.62;
                            radar_point[type] = 1;
                            break;
                        case "L":
                            score[type] = 0.55;
                            radar_point[type] = 0;
                            break;
                        case "P":
                            score[type] = 0.2;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "AC":
                    switch (selection) {
                        case "H":
                            score[type] = 0.44;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.77;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;
                case "PR":
                    switch (selection) {
                        case "N":
                            score[type] = "N";
                            radar_point["PR"] = 2;
                            break;
                        case "L":
                            score[type] = "L";
                            radar_point["PR"] = 1;
                            break;
                        case "H":
                            score[type] = "H";
                            radar_point["PR"] = 0;
                            break;
                        default:
                            break;
                    }
                case "UI":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "R":
                            score[type] = 0.62;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "S":
                    switch (selection) {
                        case "U":
                            score[type] = 6.42;
                            radar_point[type] = 0;
                            break;
                        case "C":
                            score[type] = 7.52;
                            radar_point[type] = 2;
                        default:
                            break;
                    }
                    break;
                case "C":
                case "I":
                case "A":
                    switch (selection) {
                        case "N":
                            score[type] = 0.0;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.22;
                            radar_point[type] = 1;
                            break;
                        case "H":
                            score[type] = 0.56;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;        
                default:
                    break;
            }       
        }

        if (score["S"] == 6.42) {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score[type] = 0.62;
                    break;
                case "H":
                    score[type] = 0.27;
                    break;
                default:
                    break;
            } 
        }
        else {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score["PR"] = 0.68;
                    break;
                case "H":
                    score["PR"] = 0.5;
                    break;
                default:
                    break;
            }
        }


        var impact = 1 - (1 - score["C"]) * (1 - score["I"]) * (1 - score["A"])
        if (score["S"] == 6.42) {
            impact =  6.42 * impact;
        }
        else {
            impact = 7.52 * (impact - 0.029) - 3.25 * Math.pow((impact - 0.02), 15);
        }

        var exploitability = 8.22 * score["AV"] * score["AC"] * score["PR"] * score["UI"];


        impact = Math.round(impact*2)/2    

        if (impact <= 1.5) {
            impact = "Mineur"
        } 
        else if (impact > 1.5 && impact <= 3) {
            impact = "Important"
        }
        else if (impact > 3 && impact <= 4.5 ){
            impact = "Majeur"
        }
        else {
            impact = "Critique"
        }

        
        exploitability = Math.round(exploitability)

        if (exploitability <= 1) {
            exploitability = "Difficile"
        } 
        else if (exploitability > 1 && exploitability <= 2) {
            exploitability = "Elevee"
        } 
        else if (exploitability > 2 && exploitability <= 3) {
            exploitability = "Moyen"
        }
        else {
            exploitability = "Facile"
        }

        const risk_matrix = {
            "Mineur": {"Difficile": "Mineur", "Elevee": "Mineur", "Moyen": "Important", "Facile": "Majeur"},
            "Important": {"Difficile": "Mineur", "Elevee": "Important", "Moyen": "Important", "Facile": "Majeur"},
            "Majeur": {"Difficile": "Important", "Elevee": "Majeur", "Moyen": "Majeur", "Facile": "Critique"},
            "Critique": {"Difficile": "Important", "Elevee": "Majeur", "Moyen": "Critique", "Facile": "Critique"}
        } 
        
        var risk = risk_matrix[impact][exploitability]

        var myForm = document.getElementById("edit_issue_form");
        var element_impact = document.getElementsByName("impact")[0];
        var element_exploitability = document.getElementsByName("exploitability")[0];
        var element_risk = document.getElementsByName("risk")[0];
        

        if (element_impact) {
            element_impact.setAttribute("value", impact);
        }
        else {
            var element_impact = document.createElement("input");
            element_impact.setAttribute("type", "hidden");
            element_impact.setAttribute("value", impact);
            element_impact.setAttribute("name", "impact");
            myForm.appendChild(element_impact);
        }

        if (element_exploitability) {
            element_exploitability.setAttribute("value", exploitability);
        }
        else {
            var element_exploitability = document.createElement("input");
            element_exploitability.setAttribute("type", "hidden");
            element_exploitability.setAttribute("value", exploitability);
            element_exploitability.setAttribute("name", "exploitability");
            myForm.appendChild(element_exploitability);
        }
        
        if (element_risk) {
            element_risk.setAttribute("value", risk);
        }
        else {
            var element_risk = document.createElement("input");
            element_risk.setAttribute("type", "hidden");
            element_risk.setAttribute("value", risk);
            element_risk.setAttribute("name", "risk");
            myForm.appendChild(element_risk);
        }

        score_cvss = c1.get().score;



        config.data.datasets[0].data[0] = radar_point["I"];
        config.data.datasets[0].data[1] = radar_point["A"];
        config.data.datasets[0].data[2] = radar_point["AV"];
        config.data.datasets[0].data[3] = radar_point["AC"];
        config.data.datasets[0].data[4] = radar_point["PR"];
        config.data.datasets[0].data[5] = radar_point["UI"];
        config.data.datasets[0].data[6] = radar_point["S"];
        config.data.datasets[0].data[7] = radar_point["C"];

        if (score_cvss <= 3.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.green).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.green,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.green
        }
        else if (score_cvss >= 4 && score_cvss <= 6.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.yellow).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.yellow,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.yellow
        }
        else if (score_cvss >= 7 && score_cvss <= 8.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.orange).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.orange,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.orange
        }
        else {
            config.data.datasets[0].backgroundColor = color(window.chartColors.red).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.red,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.red
        }

        myRadar.update()

    }
</script>

</html>