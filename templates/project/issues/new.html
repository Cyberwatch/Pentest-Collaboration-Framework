<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
<style>
    #canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        width: 25em !important;
        height: 25em !important;
        margin: auto;
    }
    
    #chartjs-tooltip {
        opacity: 1;
        position: absolute;
        background: rgba(0, 0, 0, .7);
        color: white;
        border-radius: 3px;
        -webkit-transition: all .1s ease;
        transition: all .1s ease;
        pointer-events: none;
        -webkit-transform: translate(-50%, 0);
        transform: translate(-50%, 0);
    }

    .chartjs-tooltip-key {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 10px;
    }
</style>
<script src=https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js></script>
<script>
    var score_cvss = 0.0;
    var image;

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(162, 213, 114)',
        blue: 'rgb(54, 162, 235)'
    };

    var color = Chart.helpers.color;

    const centerText = {
        beforeDraw: function (chart) {
            const width = chart.width
            const height = chart.height
            const ctx = chart.ctx
            ctx.restore()
            const fontSize = (height / 114).toFixed(2)
            ctx.font = 'bold ' + fontSize + 'em sans-serif'
            ctx.textBaseline = 'middle'
            ctx.fillStyle = 'white'
            ctx.strokeStyle = 'black'
            const text = score_cvss
            const textX = Math.round((width - (ctx.measureText(text).width)) / 2 - 16)
            const textY = height / 2
            ctx.fillText(text, textX, textY)
            ctx.strokeText(text, textX, textY)
            ctx.save()
        }
    }

    var config = {
        type: 'radar',
        data: {
            labels: [
                "Integrity", "Availability", "Access vector", "Attack complexity", "Privileges required", "User interaction", "Scope", "Confidentiality"],
            datasets: [{
                label: "Score",
                backgroundColor: color(window.chartColors.green).alpha(0.2).rgbString(),
                borderColor: window.chartColors.green,
                pointBackgroundColor: window.chartColors.green,
                data: [1, 1, 1, 1, 1, 1, 1, 1],
            }]
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'CVSS Score'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                r: {
                    min: -1,
                    max: 2,
                    ticks: {
                        display: false,
                        stepSize: 1
                    }
                }
            }
        },
        plugins: [centerText]
    };

    var myRadar;

    window.onload = function () {
        myRadar = new Chart(document.getElementById("canvas"), config);
    };
    var colorNames = Object.keys(window.chartColors);

    function download() {
        var a = document.createElement("a");
        a.href = myRadar.toBase64Image();
        a.download = "Image.png";
        a.click();
    }
</script>
<body>
    <div id="segment_id">
        {% include 'menu.html' %}
        {% if external_js %}
        <script src="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.js"></script>
        {% else %}
        <script src="/static/js/cvss.js"></script>
        {% endif %}
        {% if external_css %}
        <link rel="stylesheet" type="text/css" media="all" href="https://cdn.jsdelivr.net/gh/cvssjs/cvssjs/cvss.css">
        {% else %}
        <link rel="stylesheet" type="text/css" media="all" href="/static/css/cvss.css">
        {% endif %}
        <script>
            $(function () {
                $('.message .close')
                    .on('click', function () {
                        $(this)
                            .closest('.message')
                            .transition('fade')
                            ;
                    });

                $('.ui.dropdown.selection').dropdown({});

                $('.ui.checkbox').checkbox();

                $('.menu .item').tab({
                    history: true,
                    historyType: 'hash'
                });

                $('.ui.dropdown.selection').dropdown({});
            });

            var fields_list = [];

            function add_field() {
                html = `<div>
                              <h4>__field_name__ (__field_type__)</h4>
                              <input type="hidden" name="additional_field_name" value="__field_name__">
                              <input type="hidden" name="additional_field_type" value="__field_db_type__">
                                    <div class="ui two fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="__field_html_type__" placeholder="Field value" name="additional_field_value">
                                            </div>
                                        </div>
                                        <div class="field">
                                            <button class="ui button red" type="button" onclick="delete_field(this,'__field_name__');">
                                                <i class="trash icon"></i>Delete variable
                                            </button>
                                        </div>
                                    </div>
                    </div>`;
                name_obj = $('#field_name')[0];
                field_name = name_obj.value.toString();
                field_db_type = $('#field_type')[0].value.toString();
                field_html_type = 'text'
                switch (field_db_type) {
                    case 'text':
                        field_html_type = 'text';
                        field_type = 'Text';
                        break;
                    case 'number':
                        field_html_type = 'number';
                        field_type = 'Number';
                        break;
                    case 'float':
                        field_html_type = 'number';
                        field_type = 'Float';
                        break;
                    case 'boolean':
                        field_html_type = 'number';
                        field_type = 'Boolean 0..1';
                        break;
                    default:
                        field_db_type = 'text';
                        field_type = 'Text';
                        break;
                }


                var re = new RegExp("^[a-zA-Z0-9_]+$");

                if (field_name !== '' && re.test(field_name) && !fields_list.includes(field_name)) {
                    tmp_html = html.replaceAll('__field_name__', field_name)
                        .replaceAll('__field_type__', field_type)
                        .replaceAll('__field_html_type__', field_html_type)
                        .replaceAll('__field_db_type__', field_db_type);
                    fields_list.push(field_name);
                    $('#fields_list').append(tmp_html);
                    name_obj.value = '';
                } else if (fields_list.includes(field_name)) {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom left',
                            message: 'Additional field "' + field_name + '" already exists!'
                        });
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom left',
                            message: 'Wrong field name! Regexp:[a-zA-Z0-9_]+'
                        });
                }


            }

            function add_file_field() {
                html = `<div>
                        <h4>File: __field_name__</h4>
                        <input type="hidden" name="additional_field_filename" value="__field_name__">
                        <div class="ui two fields">
                            <div class="field">
                                <div class="ui input">
                                    <input type="file" required name="additional_field_file">
                                </div>
                            </div>
                            <div class="field">
                                <button class="ui button red" type="button" onclick="delete_field(this,'__field_name__');">
                                    <i class="trash icon"></i>Delete variable
                                </button>
                            </div>
                        </div>
                    </div>`;
                name_obj = $('#file_name')[0];
                field_name = name_obj.value.toString();


                var re = new RegExp("^[a-zA-Z0-9_]+$");

                if (field_name !== '' && re.test(field_name) && !fields_list.includes(field_name)) {
                    tmp_html = html.replaceAll('__field_name__', field_name)
                    fields_list.push(field_name);
                    $('#files_list').append(tmp_html);
                    name_obj.value = '';
                } else if (fields_list.includes(field_name)) {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom left',
                            message: 'Additional field "' + field_name + '" already exists!'
                        });
                } else {
                    $('body')
                        .toast({
                            class: 'error',
                            position: 'bottom left',
                            message: 'Wrong field name! Regexp:[a-zA-Z0-9_]+'
                        });
                }

            }

            function delete_field(button_obj, field_name) {
                elem = button_obj.parentElement.parentElement.parentElement;
                elem.parentNode.removeChild(elem);

                for (var i = 0; i < fields_list.length; i++) {
                    if (fields_list[i] === field_name) {
                        fields_list.splice(i, 1);
                    }
                }
            }

            function list_ips(list_hosts, search_field) {
                list_elem = $('#host-port-list')[0];
                list_elem.innerHTML = '';
                var text_html = '';
                var shown_html = '';
                var count = 0;
                for (var i = 0; i < list_hosts.length; i++) {
                    s = list_hosts[i]['ip'];
                    if (list_hosts[i]['port'] !== 0) {
                        s += ':' + list_hosts[i]['port'];
                        if (list_hosts[i]['is_tcp']) {
                            s += '(tcp)';
                        } else {
                            s += '(udp)';
                        }
                    }
                    check_str = '';
                    if (list_hosts[i]['checked']) {
                        check_str = 'checked';
                    }
                    if (s.includes(search_field.toLowerCase()) || search_field === '') {

                        inner = `<div class="ui item checkbox" data-value="item1" id="ip_row">
                                <input type="checkbox" name="ip_port-${i}" value="${list_hosts[i]['port_id']}" ${check_str} onchange="switch_host('${list_hosts[i]['port_id']}','0')">
                                <label>${s}</label>
                            </div>`;
                        if (list_hosts[i]['checked']) {
                            shown_html += inner;
                        } else {
                            text_html += inner;
                            count += 1;
                        }
                    } else if (list_hosts[i]['checked']) {
                        inner = `<div class="ui item checkbox" data-value="item1" id="ip_row" style="display: none;">
                                <input type="checkbox" name="ip_port-${i}" value="${list_hosts[i]['port_id']}" checked>
                                <label>${s}</label>
                            </div>`;
                        shown_html += inner;
                    }
                }
                if (count > 1000) {
                    text_html = shown_html + `<div class="ui item" data-value="item1" id="ip_row">
                                <label>Too much results (${count})..</label>
                            </div>`;
                }
                list_elem.innerHTML += shown_html + text_html;

                $('#ip_row').checkbox();
                $('.ui.checkbox').checkbox();

            }

            function list_hostnames(list_hosts, search_field) {
                list_elem = $('#hostname-port-list')[0];
                list_elem.innerHTML = '';
                var text_html = '';
                var shown_html = '';
                var count = 0;
                for (var i = 0; i < list_hosts.length; i++) {
                    s = list_hosts[i]['hostname'];
                    if (list_hosts[i]['port'] !== 0) {
                        s += ':' + list_hosts[i]['port'];
                        if (list_hosts[i]['is_tcp']) {
                            s += '(tcp)';
                        } else {
                            s += '(udp)';
                        }
                    }
                    check_str = '';
                    if (list_hosts[i]['checked']) {
                        check_str = 'checked';
                    }
                    if (s.includes(search_field.toLowerCase()) || search_field === '') {

                        inner = `<div class="ui item checkbox" data-value="item1" id="hostname_row">
                                <input type="checkbox" name="host_port-${i}" value="${list_hosts[i]['port_id']}:${list_hosts[i]['hostname_id']}" ${check_str} onchange="switch_host('${list_hosts[i]['port_id']}','${list_hosts[i]['hostname_id']}')">
                                <label>${s}</label>
                            </div>`;
                        if (list_hosts[i]['checked']) {
                            shown_html += inner;
                        } else {
                            text_html += inner;
                            count += 1;
                        }
                    } else if (list_hosts[i]['checked']) {
                        inner = `<div class="ui item checkbox" data-value="item1" id="hostname_row" style="display: none;">
                                <input type="checkbox" name="host_port-${i}" value="${list_hosts[i]['port_id']}:${list_hosts[i]['hostname_id']}" checked>
                                <label>${s}</label>
                            </div>`;
                        shown_html += inner;
                    }
                }
                if (count > 1000) {
                    text_html = shown_html + `<div class="ui item" data-value="item1" id="hostname_row">
                                <label>Too much results (${count})..</label>
                            </div>`;
                } else {
                    list_elem.innerHTML += shown_html + text_html;
                }

                $('#hostname_row').checkbox();
                $('.ui.checkbox').checkbox();

            }

            var ips = [];
            var hostnames = [];

            // add hosts
            $(document).ready(function () {
                $.getJSON("issues/hosts_ports_list", function (j) {
                    ips = j.ips;
                    hostnames = j.hostnames;
                    list_ips(ips, '');
                    list_hostnames(hostnames, '');
                });


                input = $('#input_search_ip')[0];

                input.oninput = function () {
                    value = $('#input_search_ip')[0].value;
                    list_ips(ips, value);
                };

                input = $('#input_search_hostname')[0];

                input.oninput = function () {
                    value = $('#input_search_hostname')[0].value;
                    list_hostnames(hostnames, value);
                };
            });

            function switch_host(port_id, hostname_id) {
                if (hostname_id === '0') {
                    for (var i = 0; i < ips.length; i++) {
                        s = ips[i]['port_id'];
                        if (s === port_id) {
                            ips[i]['checked'] = !ips[i]['checked'];
                            return;
                        }
                    }
                } else {
                    for (var i = 0; i < hostnames.length; i++) {
                        port = hostnames[i]['port_id'];
                        hostname = hostnames[i]['hostname_id'];
                        if (port === port_id && hostname === hostname_id) {
                            hostnames[i]['checked'] = !hostnames[i]['checked'];
                            return;
                        }
                    }
                }
            }
        </script>
        <style>
            .ui.dropdown .menu {
                min-width: 100%;
            }

            .ui.dropdown.dropdown .menu>.input {
                min-width: 80%;
            }
        </style>
        <div class="ui grid">
            <div class="ui column" style="width: 75px; padding-top: 50px;">
                {% include 'project/sidebar.html' %}
            </div>
            <div class="ui column" style="width: calc(100% - 75px)">
                <h1 class="ui dividing header">Create new issue</h1>
                <div class="ui top attached tabular menu" style="margin-bottom: 10px">
                    <a class="item active" data-tab="info">
                        Info
                    </a>
                    <a class="item" data-tab="fields">
                        Additional fields
                    </a>
                </div>
                <form class="ui form" enctype="multipart/form-data" method="post" id="new_issue_form"
                    action="/project/{{ current_project['id'] }}/new_issue" style="margin-top: 15px; width: 100%" onsubmit="canva_to_b64('new_issue_form')"
                    novalidate>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="ui tab active" data-tab="info">
                        <div class="ui grid" style="width: 100%">
                            <div class="eight wide column">
                                <div class="ui container" style="width: 90%; float: left;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="at icon"></i>Name:
                                            </div>
                                            <input type="text" name="name" placeholder="SQL injection.." required>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="sticky note outline icon"></i>Description:
                                            </div>
                                            <textarea rows="5" name="description"
                                                placeholder="Vulnerability description"></textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="medkit icon"></i>Fix:
                                            </div>
                                            <textarea rows="3" name="fix"
                                                placeholder="To fix this vulnerability you need..."></textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="cog icon"></i>Technical:
                                            </div>
                                            <textarea rows="8" name="technical"
                                                placeholder="Technical information about issue"></textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="exclamation triangle icon"></i>Risks:
                                            </div>
                                            <textarea rows="3" name="risks"
                                                placeholder="Issue exploitation risks"></textarea>
                                        </div>
                                    </div>
                                    <div class="ui field">
                                        <div class="ui labeled input">
                                            <div class="ui label" style="width: 125px;">
                                                <i class="linkify icon"></i>References:
                                            </div>
                                            <textarea rows="2" name="references"
                                                placeholder="Some links with issue information"></textarea>
                                        </div>
                                    </div>
                                    <div class="ui grid" style="height: 400px;">
                                        <div class="eight wide column">
                                            <div class="ui field">
                                                <div class="ui dropdown" id="hosts_list"
                                                    style="width: 100%; min-width: 100%">
                                                    <div class="menu transition visible" style="width: 90%;">
                                                        <div class="ui icon search input">
                                                            <i class="search icon"></i>
                                                            <input type="text" name="Search"
                                                                placeholder="Search&hellip;" id="input_search_ip">
                                                        </div>
                                                        <div class="scrolling menu" style="height:270px;"
                                                            id="host-port-list">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="eight wide column">
                                            <div class="ui field">
                                                <div class="ui dropdown" id="hostnames_list" style="width: 100%;">
                                                    <div class="menu transition visible" style="width: 90%;">
                                                        <div class="ui icon search input">
                                                            <i class="search icon"></i>
                                                            <input type="text" name="Search"
                                                                placeholder="Search&hellip;" id="input_search_hostname">
                                                        </div>
                                                        <div class="scrolling menu" style="height:270px;"
                                                            id="hostname-port-list">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <button class="ui button blue"><i class="plus icon"></i>Add</button>


                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="folder open icon"></i>URL path/service:
                                        </div>
                                        <input type="text" name="url" placeholder="/admin/">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input" style="margin: 0 0 1em;">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CVSS:
                                        </div>
                                        <input type="text" id="origin_cvss" name="cvss" step="0.01" min="0" max="10" readonly="readonly"
                                            placeholder="10.0" value="" style="width: 100px;">
                                    </div>
                                    <div class="ui labeled input" style="margin: 0 0 1em;">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>Vector:
                                        </div>
                                        <input id="origin_cvss_vector" type="text" name="cvss_vector" readonly="readonly"
                                            placeholder="CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N"
                                            value="">
                                        
                                    </div>
                                    <div style="text-align: center;">
                                        <button type="button" class="ui button blue"
                                                onclick="$('#cvss_hidden').toggle();">
                                                <i class="ui calculator icon"></i>CVSS calculator
                                        </button>
                                    </div>
                                </div>
                                <div id="cvss_hidden" style="display: none">
                                    <div class="ui divider"></div>
                                    <div id="cvssboard">
                                    </div>
                                    <div id="chartjs-radar">
                                        <canvas id="canvas"></canvas>
                                    </div>
                                    <div class="ui divider"></div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CVE:
                                        </div>
                                        <input type="text" name="cve" placeholder="2020-1337">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="hashtag icon"></i>CWE:
                                        </div>
                                        <input type="number" name="cwe" placeholder="123">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="question circle icon"></i>Status:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="status" required value="Need to recheck">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select status</div>
                                            <div class="menu">
                                                <div class="item" data-value="PoC creation">PoC creation</div>
                                                <div class="item" data-value="PoC available">PoC available</div>
                                                <div class="item" data-value="Confirmed">Confirmed</div>
                                                <div class="item" data-value="Wasn't Confirmed">Wasn't Confirmed</div>
                                                <div class="item" data-value="Pending...">Pending...</div>
                                                <div class="item" data-value="Need to check">Need to check</div>
                                                <div class="item" data-value="Need to recheck">Need to recheck</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="exclamation triangle icon"></i>Criticality:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="criticality" required value="-1">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select criticality</div>
                                            <div class="menu">
                                                <div class="item" data-value="-1">use CVSS criticality</div>
                                                <div class="item" data-value="0"><i
                                                        class="warning circle blue icon"></i>Information (cvss=0.0)
                                                </div>
                                                <div class="item" data-value="2"><i
                                                        class="warning circle green icon"></i>Low (cvss=2.0)</div>
                                                <div class="item" data-value="5"><i
                                                        class="warning circle yellow icon"></i>Medium (cvss=5.0)</div>
                                                <div class="item" data-value="8"><i
                                                        class="warning circle orange icon"></i>High (cvss=8.0)</div>
                                                <div class="item" data-value="9.5"><i
                                                        class="warning circle red icon"></i>Critical (cvss=9.5)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="desktop icon"></i>Parameter:
                                        </div>
                                        <input type="text" name="param" placeholder="(GET) id=123">
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="desktop icon"></i>Type:
                                        </div>
                                        <div class="ui fluid selection dropdown" id="services_list">
                                            <input type="hidden" name="issue_type" required value="custom">
                                            <i class="dropdown icon"></i>
                                            <div class="default text">Select type</div>
                                            <div class="menu">
                                                <div class="item" data-value="custom">Custom</div>
                                                <div class="item" data-value="web">Web</div>
                                                <div class="item" data-value="credentials">Credentials</div>
                                                <div class="item" data-value="service">Service</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="ui field">
                                    <div class="ui labeled input">
                                        <div class="ui label" style="width: 170px;">
                                            <i class="user secret icon"></i>Intruder:
                                        </div>
                                        <input type="text" name="intruder"
                                            placeholder="Noire / Grise / Blanche">
                                    </div>
                                </div>
                                {% if errors is defined and errors %}
                                <div class="ui error message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        There were some errors with issue
                                    </div>
                                    <ul class="list">
                                        {% for error in errors %}
                                        <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}

                                {% if errors is defined and not errors %}
                                <div class="ui success message visible">
                                    <i class="close icon"></i>
                                    <div class="header">
                                        Issue was added successfully!
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="ui tab" data-tab="fields">
                        <div class="ui grid">
                            <div class="two column row">

                                <div class="ui column">
                                    <h2 class="ui dividing header">Text fields</h2>

                                    <div id="fields_list">
                                    </div>

                                    <div class="divider"></div>
                                    <h3 class="ui dividing header">Add field</h3>
                                    <div class="ui three fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="text" id="field_name"
                                                    placeholder="field_name [a-zA-Z0-9_]"> </input>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <div class="ui fluid selection dropdown">
                                                <input type="hidden" id="field_type" value="text" required>
                                                <i class="dropdown icon"></i>
                                                <div class="default text">Select field type</div>
                                                <div class="menu">
                                                    <div class="item" data-value="text">Text field</div>
                                                    <div class="item" data-value="number">Number field</div>
                                                    <div class="item" data-value="float">Float field</div>
                                                    <div class="item" data-value="boolean">Boolean field</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <button class="ui button blue" type="button" onclick="add_field();">
                                                <i class="icon plus"></i>Add variable
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="ui column">
                                    <h2 class="ui dividing header">File fields</h2>

                                    <div id="files_list"></div>

                                    <h3 class="ui dividing header">Add field</h3>
                                    <div class="ui two fields">
                                        <div class="field">
                                            <div class="ui input">
                                                <input type="text" placeholder="field_name1 [a-zA-Z0-9_]"
                                                    id="file_name"> </input>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <button class="ui button blue" type="button" onclick="add_file_field()">
                                                <i class="icon plus"></i>Add variable
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <script>
                var elements = document.querySelectorAll('[id=hostname_row]');
                for (i = 0; i < elements.length; i++) {
                    is_checked = elements[i].children[0].checked;
                    if (is_checked) {
                        elements[i].parentNode.prepend(elements[i]);
                    } else {

                    }
                }
                ;
                elements = document.querySelectorAll('[id=ip_row]');
                for (i = 0; i < elements.length; i++) {
                    is_checked = elements[i].children[0].checked;
                    if (is_checked) {
                        elements[i].parentNode.prepend(elements[i]);
                    } else {

                    }
                }
            </script>
            {% include 'footer.html' %}
        </div>
    </div>
</body>
<script>

function canva_to_b64(id) {
        var cvss_image = myRadar.toBase64Image();
        var myForm = document.getElementById(id);
        var element = document.createElement("input");
        element.setAttribute("type", "text");
        element.setAttribute("value", cvss_image);
        element.setAttribute("name", "cvss_graph");
        myForm.appendChild(element)
    }

    var c1 = new CVSS("cvssboard", {
        onchange: function () {
            c1.vector.setAttribute('href', '#' + c1.get().vector)
            document.getElementById('origin_cvss').value = c1.get().score;
            document.getElementById('origin_cvss_vector').value = c1.get().vector;
            action()
        }
    });
    cvss_vector = "";
    if (cvss_vector !== '') {
        c1.set(cvss_vector);
    }



    function action() {
        var tmp = c1.get().vector.split("/");
        var score = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        var radar_point = {"AV": 0, "AC": 0, "PR": 0, "UI": 0, "S": 0, "C": 0, "I": 0, "A": 0};
        for (let index = 1; index < tmp.length; index++) {
            var type = tmp[index].split(":")[0];
            var selection = tmp[index].split(":")[1];
            switch (type) {
                case "AV":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "A":
                            score[type] = 0.62;
                            radar_point[type] = 1;
                            break;
                        case "L":
                            score[type] = 0.55;
                            radar_point[type] = 0;
                            break;
                        case "P":
                            score[type] = 0.2;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "AC":
                    switch (selection) {
                        case "H":
                            score[type] = 0.44;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.77;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;
                case "PR":
                    switch (selection) {
                        case "N":
                            score[type] = "N";
                            radar_point["PR"] = 2;
                            break;
                        case "L":
                            score[type] = "L";
                            radar_point["PR"] = 1;
                            break;
                        case "H":
                            score[type] = "H";
                            radar_point["PR"] = 0;
                            break;
                        default:
                            break;
                    }
                case "UI":
                    switch (selection) {
                        case "N":
                            score[type] = 0.85;
                            radar_point[type] = 2;
                            break;
                        case "R":
                            score[type] = 0.62;
                            radar_point[type] = 0;
                            break;
                        default:
                            break;
                    }
                    break;
                case "S":
                    switch (selection) {
                        case "U":
                            score[type] = 6.42;
                            radar_point[type] = 0;
                            break;
                        case "C":
                            score[type] = 7.52;
                            radar_point[type] = 2;
                        default:
                            break;
                    }
                    break;
                case "C":
                case "I":
                case "A":
                    switch (selection) {
                        case "N":
                            score[type] = 0.0;
                            radar_point[type] = 0;
                            break;
                        case "L":
                            score[type] = 0.22;
                            radar_point[type] = 1;
                            break;
                        case "H":
                            score[type] = 0.56;
                            radar_point[type] = 2;
                            break;
                        default:
                            break;
                    }
                    break;        
                default:
                    break;
            }       
        }

        if (score["S"] == 6.42) {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score[type] = 0.62;
                    break;
                case "H":
                    score[type] = 0.27;
                    break;
                default:
                    break;
            } 
        }
        else {
            switch (score["PR"]) {
                case "N":
                    score["PR"] = 0.85;
                    break;
                case "L": 
                    score["PR"] = 0.68;
                    break;
                case "H":
                    score["PR"] = 0.5;
                    break;
                default:
                    break;
            }
        }


        var impact = 1 - (1 - score["C"]) * (1 - score["I"]) * (1 - score["A"])
        if (score["S"] == 6.42) {
            impact =  6.42 * impact;
        }
        else {
            impact = 7.52 * (impact - 0.029) - 3.25 * Math.pow((impact - 0.02), 15);
        }

        var exploitability = 8.22 * score["AV"] * score["AC"] * score["PR"] * score["UI"];


        impact = Math.round(impact*2)/2    

        if (impact <= 1.5) {
            impact = "Mineur"
        } 
        else if (impact > 1.5 && impact <= 3) {
            impact = "Important"
        }
        else if (impact > 3 && impact <= 4.5 ){
            impact = "Majeur"
        }
        else {
            impact = "Critique"
        }

        
        exploitability = Math.round(exploitability)

        if (exploitability <= 1) {
            exploitability = "Difficile"
        } 
        else if (exploitability > 1 && exploitability <= 2) {
            exploitability = "Elevee"
        } 
        else if (exploitability > 2 && exploitability <= 3) {
            exploitability = "Moyen"
        }
        else {
            exploitability = "Facile"
        }

        const risk_matrix = {
            "Mineur": {"Difficile": "Mineur", "Elevee": "Mineur", "Moyen": "Important", "Facile": "Majeur"},
            "Important": {"Difficile": "Mineur", "Elevee": "Important", "Moyen": "Important", "Facile": "Majeur"},
            "Majeur": {"Difficile": "Important", "Elevee": "Majeur", "Moyen": "Majeur", "Facile": "Critique"},
            "Critique": {"Difficile": "Important", "Elevee": "Majeur", "Moyen": "Critique", "Facile": "Critique"}
        } 
        
        var risk = risk_matrix[impact][exploitability]

        var myForm = document.getElementById("new_issue_form");
        var element_impact = document.getElementsByName("impact")[0];
        var element_exploitability = document.getElementsByName("exploitability")[0];
        var element_risk = document.getElementsByName("risk")[0];
        

        if (element_impact) {
            element_impact.setAttribute("value", impact);
        }
        else {
            var element_impact = document.createElement("input");
            element_impact.setAttribute("type", "hidden");
            element_impact.setAttribute("value", impact);
            element_impact.setAttribute("name", "impact");
            myForm.appendChild(element_impact);
        }

        if (element_exploitability) {
            element_exploitability.setAttribute("value", exploitability);
        }
        else {
            var element_exploitability = document.createElement("input");
            element_exploitability.setAttribute("type", "hidden");
            element_exploitability.setAttribute("value", exploitability);
            element_exploitability.setAttribute("name", "exploitability");
            myForm.appendChild(element_exploitability);
        }
        
        if (element_risk) {
            element_risk.setAttribute("value", risk);
        }
        else {
            var element_risk = document.createElement("input");
            element_risk.setAttribute("type", "hidden");
            element_risk.setAttribute("value", risk);
            element_risk.setAttribute("name", "risk");
            myForm.appendChild(element_risk);
        }

        score_cvss = c1.get().score;

        config.data.datasets[0].data[0] = radar_point["I"];
        config.data.datasets[0].data[1] = radar_point["A"];
        config.data.datasets[0].data[2] = radar_point["AV"];
        config.data.datasets[0].data[3] = radar_point["AC"];
        config.data.datasets[0].data[4] = radar_point["PR"];
        config.data.datasets[0].data[5] = radar_point["UI"];
        config.data.datasets[0].data[6] = radar_point["S"];
        config.data.datasets[0].data[7] = radar_point["C"];

        if (score_cvss <= 3.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.green).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.green,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.green
        }
        else if (score_cvss >= 4 && score_cvss <= 6.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.yellow).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.yellow,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.yellow
        }
        else if (score_cvss >= 7 && score_cvss <= 8.9) {
            config.data.datasets[0].backgroundColor = color(window.chartColors.orange).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.orange,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.orange
        }
        else {
            config.data.datasets[0].backgroundColor = color(window.chartColors.red).alpha(0.2).rgbString(),
                config.data.datasets[0].borderColor = window.chartColors.red,
                config.data.datasets[0].pointBackgroundColor = window.chartColors.red
        }

        myRadar.update()

    }
</script>

</html>